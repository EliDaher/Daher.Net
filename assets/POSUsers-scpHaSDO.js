import{r as l,u as ee,a as te,j as e,c as ae,P as U,b as _,d as re,e as se,f as F,g as ne,h as le,i as E}from"./index-DjtrOvVI.js";import{D as I}from"./DataTable-BcblhkSS.js";import{C as oe,D as L}from"./DashboardLayout-BHIEqfHp.js";import{B as v}from"./button-BK6lVoHu.js";import{P as R}from"./PopupForm-D1G_mMS6.js";import{I as h}from"./input-DK-39AZO.js";import{A as ie,a as de,b as ce,d as ue,e as me,g as be,c as pe,f as xe}from"./pos-G0YoL6LZ.js";import{u as O}from"./useMutation-BHAbwPe4.js";import{u as he}from"./index-BMhVl2ff.js";import{S as fe,a as ye,b as ge,c as je,d as A}from"./select-_uiUeovW.js";import"./card-CLiHiovH.js";import"./house-C1D2S_pc.js";var q="Checkbox",[ve,Ke]=ae(q),[ke,Ce]=ve(q),M=l.forwardRef((s,a)=>{const{__scopeCheckbox:r,name:o,checked:p,defaultChecked:m,required:f,disabled:n,value:i="on",onCheckedChange:c,...S}=s,[d,y]=l.useState(null),D=ee(a,u=>y(u)),g=l.useRef(!1),w=d?!!d.closest("form"):!0,[x=!1,P]=te({prop:p,defaultProp:m,onChange:c}),N=l.useRef(x);return l.useEffect(()=>{const u=d==null?void 0:d.form;if(u){const k=()=>P(N.current);return u.addEventListener("reset",k),()=>u.removeEventListener("reset",k)}},[d,P]),e.jsxs(ke,{scope:r,state:x,disabled:n,children:[e.jsx(U.button,{type:"button",role:"checkbox","aria-checked":C(x)?"mixed":x,"aria-required":f,"data-state":Q(x),"data-disabled":n?"":void 0,disabled:n,value:i,...S,ref:D,onKeyDown:_(s.onKeyDown,u=>{u.key==="Enter"&&u.preventDefault()}),onClick:_(s.onClick,u=>{P(k=>C(k)?!0:!k),w&&(g.current=u.isPropagationStopped(),g.current||u.stopPropagation())})}),w&&e.jsx(Se,{control:d,bubbles:!g.current,name:o,value:i,checked:x,required:f,disabled:n,style:{transform:"translateX(-100%)"}})]})});M.displayName=q;var B="CheckboxIndicator",K=l.forwardRef((s,a)=>{const{__scopeCheckbox:r,forceMount:o,...p}=s,m=Ce(B,r);return e.jsx(re,{present:o||C(m.state)||m.state===!0,children:e.jsx(U.span,{"data-state":Q(m.state),"data-disabled":m.disabled?"":void 0,...p,ref:a,style:{pointerEvents:"none",...s.style}})})});K.displayName=B;var Se=s=>{const{control:a,checked:r,bubbles:o=!0,...p}=s,m=l.useRef(null),f=he(r),n=se(a);return l.useEffect(()=>{const i=m.current,c=window.HTMLInputElement.prototype,d=Object.getOwnPropertyDescriptor(c,"checked").set;if(f!==r&&d){const y=new Event("click",{bubbles:o});i.indeterminate=C(r),d.call(i,C(r)?!1:r),i.dispatchEvent(y)}},[f,r,o]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:C(r)?!1:r,...p,tabIndex:-1,ref:m,style:{...s.style,...n,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function C(s){return s==="indeterminate"}function Q(s){return C(s)?"indeterminate":s?"checked":"unchecked"}var H=M,Pe=K;const T=l.forwardRef(({className:s,...a},r)=>e.jsx(H,{ref:r,className:F("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...a,children:e.jsx(Pe,{className:F("flex items-center justify-center text-current"),children:e.jsx(oe,{className:"h-4 w-4"})})}));T.displayName=H.displayName;var Ne="Label",V=l.forwardRef((s,a)=>e.jsx(U.label,{...s,ref:a,onMouseDown:r=>{var p;r.target.closest("button, input, select, textarea")||((p=s.onMouseDown)==null||p.call(s,r),!r.defaultPrevented&&r.detail>1&&r.preventDefault())}}));V.displayName=Ne;var $=V;const Oe=ne("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),j=l.forwardRef(({className:s,...a},r)=>e.jsx($,{ref:r,className:F(Oe(),s),...a}));j.displayName=$.displayName;function we({onSubmit:s}){const[a,r]=l.useState({email:"",password:"",name:"",number:"",card:{cardInternet:!0,cardSyriatel:!0,cardPlay:!0,cardapplication:!0,cardPronet:!1,cardHifi:!1},role:"user",balance:0}),o=n=>{const{name:i,value:c,type:S}=n.target;r({...a,[i]:S==="number"?Number(c):c})},p=(n,i)=>{r({...a,card:{...a.card,[n]:i}})},m=n=>{r({...a,role:n})},f=n=>{n.preventDefault(),s&&s(a),r({email:"",password:"",name:"",number:"",card:{cardInternet:!0,cardSyriatel:!0,cardPlay:!0,cardapplication:!0,cardPronet:!1,cardHifi:!1},role:"user",balance:0})};return e.jsx("div",{dir:"rtl",className:"max-w-md mx-auto bg-white rounded-lg shadow-md",children:e.jsxs("form",{onSubmit:f,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"email",children:"البريد الإلكتروني"}),e.jsx(h,{id:"email",name:"email",type:"text",value:a.email,onChange:o,required:!0})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"password",children:"كلمة المرور"}),e.jsx(h,{id:"password",name:"password",type:"password",value:a.password,onChange:o})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"name",children:"الاسم"}),e.jsx(h,{id:"name",name:"name",type:"text",value:a.name,onChange:o})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"number",children:"الرقم"}),e.jsx(h,{id:"number",name:"number",type:"text",value:a.number,onChange:o})]}),e.jsxs("div",{children:[e.jsx(j,{children:"البطاقات"}),e.jsx("div",{className:"space-y-2",children:Object.entries(a.card).map(([n,i])=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{id:n,checked:i,onCheckedChange:c=>p(n,c)}),e.jsx(j,{htmlFor:n,children:n.replace("card","")})]},n))})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"role",children:"الدور"}),e.jsxs(fe,{value:a.role,onValueChange:m,children:[e.jsx(ye,{children:e.jsx(ge,{placeholder:"اختر الدور"})}),e.jsxs(je,{children:[e.jsx(A,{value:"user",children:"مستخدم"}),e.jsx(A,{value:"admin",children:"مدير"})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"balance",children:"الرصيد"}),e.jsx(h,{id:"balance",name:"balance",type:"number",value:a.balance,onChange:o})]}),e.jsx(v,{type:"submit",className:"w-full",children:"إضافة المستخدم"})]})})}function Qe(){const[s,a]=l.useState(0),[r,o]=l.useState(null),[p,m]=l.useState(null),[f,n]=l.useState(!1),i=le(),[c,S]=l.useState({username:"",agent:"",owner:"",password:"",number:"",createdAt:new Date().toISOString().split("T")[0]}),d=t=>{S({...c,[t.target.name]:t.target.value})},{data:y,isLoading:D}=E({queryKey:["POSReport-table"],queryFn:be});l.useEffect(()=>{console.log(y)},[y]);const{data:g,isLoading:w}=E({queryKey:["POSUsers-table"],queryFn:pe}),{data:x,isLoading:P}=E({queryKey:["POSdebt-table"],queryFn:xe}),N=O({mutationFn:de,onSuccess:()=>{alert("تمت إضافة الدفعة."),i.invalidateQueries({queryKey:["POSdebt-table"]}),o(null),a(0)},onError:()=>{alert("حدث خطأ أثناء الإرسال.")}}),u=O({mutationFn:me,onSuccess:()=>{alert("تم انهاء الدين."),i.invalidateQueries({queryKey:["POSdebt-table"]}),o(null),a(0)},onError:()=>{alert("حدث خطأ أثناء الإرسال.")}}),k=O({mutationFn:ce,onSuccess:()=>{alert("تم اضافة نقطة البيع."),i.invalidateQueries({queryKey:["POSUsers-table"]}),o(null),a(0)},onError:()=>{alert("حدث خطأ أثناء الإرسال.")}}),z=O({mutationFn:ue,onSuccess:()=>{alert("تم حذف المستخدم بنجاح."),i.invalidateQueries({queryKey:["POSUsers-table"]}),o(null),a(0)},onError:()=>{alert("حدث خطأ أثناء الإرسال.")}}),X=O({mutationFn:ie,onSuccess:()=>{alert("تم إضافة المستخدم بنجاح."),i.invalidateQueries({queryKey:["POSUsers-table"]}),n(!1)},onError:()=>{alert("حدث خطأ أثناء إضافة المستخدم.")}}),G=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"email",label:"البريد الإلكتروني",sortable:!0},{key:"confirmedDeposits",label:"الايداعات المؤكدة",sortable:!0},{key:"expensesPaid",label:"المصاريف المدفوعة",sortable:!0},{key:"netBalance",label:"الرصيد الصافي",sortable:!0},{key:"POSbalance",label:"الميزانية",sortable:!0},{key:"balance",label:"الرصيد",sortable:!0},{key:"expensesInProgress",label:"المصاريف الجارية",sortable:!0},{key:"totalDeposits",label:"إجمالي الإيداعات",sortable:!0},{key:"finalBalance",label:"الرصيد النهائي",sortable:!0},{key:"unconfirmedDeposits",label:"الايداعات المرفوضة",sortable:!0},{key:"expensesUnpaid",label:"المصاريف غير المدفوعة",sortable:!0},{key:"totalExpenses",label:"إجمالي المصاريف",sortable:!0}],J=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"email",label:"email",sortable:!0},{key:"password",label:"كلمة السر",sortable:!0},{key:"role",label:"الصلاحية",sortable:!0},{key:"balance",label:"الرصيد",sortable:!0},{key:"number",label:"الرقم",sortable:!0}],W=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"destination",label:"الوجهة",sortable:!0},{key:"name",label:"الاسم",sortable:!0},{key:"number",label:"الرقم",sortable:!0},{key:"operator",label:"المنفذ",sortable:!0},{key:"amount",label:"الكمية",sortable:!0},{key:"date",label:"التاريخ",sortable:!0}],Y=l.useMemo(()=>(x==null?void 0:x.reduce((t,b)=>t+Number(b.amount),0))??0,[x]),Z=l.useMemo(()=>(g==null?void 0:g.reduce((t,b)=>t+Number(b.balance),0))??0,[g]);return w||P?e.jsx(L,{children:e.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):e.jsx(L,{children:e.jsxs("div",{dir:"rtl",className:"grid gap-4 grid-cols-1",children:[e.jsx(R,{title:"اضافة مستخدم جديد",trigger:e.jsx(v,{children:"اضافة مستخدم جديد"}),isOpen:f,setIsOpen:n,children:e.jsx(we,{onSubmit:t=>X.mutate(t)})}),e.jsx(I,{title:"نقاط البيع",description:Z.toFixed(0)+" ل.س مجموع أرصدة نقاط البيع",columns:J,data:g,renderRowActions:t=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{title:"اضافة دفعة لنقطة البيع",trigger:e.jsx(v,{variant:"accent",children:"اضافة دفعة"}),isOpen:r===t._id,setIsOpen:b=>o(b?t._id:null),children:e.jsx("div",{children:e.jsxs("form",{className:"gap-4 flex flex-col",onSubmit:b=>{b.preventDefault(),N.mutate({id:r,amount:s})},children:[e.jsx(h,{readOnly:!0,value:t.name?t.name+"  //  "+t.email:t.email,title:"نقطة البيع"}),e.jsx(h,{value:s,onChange:b=>{a(Number(b.target.value))},type:"number",title:"قيمة الدفعة"}),e.jsx(v,{children:N.isPending?"جاري التاكيد ...":"تأكيد"})]})})}),e.jsx(R,{title:"إضافة نقطة بيع",trigger:e.jsx(v,{children:"اضافة نقطة بيع فرعية"}),isOpen:p===t._id,setIsOpen:b=>m(b?t._id:null),children:e.jsx("div",{children:e.jsxs("form",{className:"gap-4 flex flex-col",onSubmit:b=>{b.preventDefault(),k.mutate({formData:c,email:t.email})},children:[e.jsx(h,{type:"text",name:"username",placeholder:"اسم المستخدم",value:c.username,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"password",placeholder:"كلمة المرور",value:c.password,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"number",placeholder:"رقم الخليوي",value:c.number,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"agent",placeholder:"الوكيل",value:t.email,readOnly:!0,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"owner",placeholder:"اسم صاحب النقطة",value:c.owner,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(v,{children:N.isPending?"جاري التاكيد ...":"تأكيد"})]})})}),e.jsx(v,{onClick:()=>{z.mutate({id:t._id})},variant:"destructive",children:"حذف نقطة البيع"})]})}),e.jsx(I,{title:"ديون نقاط البيع",description:Y,columns:W,data:x,renderRowActions:t=>e.jsx(e.Fragment,{children:e.jsx(v,{disabled:u.isPending,onClick:()=>{window.confirm("هل انت متأكد من العملية ؟")&&u.mutate({id:t._id,email:t.email,amount:t.amount})},children:u.isPending?"جاري الانهاء...":"انهاء الدين"})})}),e.jsx(I,{title:"تقرير عمليات النقاط",data:(y==null?void 0:y.map(t=>({...t,POSbalance:t.confirmedDeposits-t.expensesPaid-t.netBalance})))||[],columns:G,isLoading:D,getRowClassName:t=>t.POSbalance!=0?"bg-destructive/20":"bg-green-500/20"})]})})}export{Qe as default};
