import{r as i,g as w,j as t}from"./index-BPTvA_Zg.js";import{D}from"./DataTable-BnyYMMZY.js";import{D as b}from"./DashboardLayout-DUqkgvyZ.js";import{B as l}from"./button-BNElTykS.js";import{P as N}from"./PopupForm-Bx_JJtpj.js";import{I as q}from"./input-DOxGAMmd.js";import{c as C,r as F,s as I,g as R}from"./invoices-BHYzYkSJ.js";import{u as Q}from"./useQuery-DtCzGHwd.js";import{u as p}from"./useMutation-CqVyVdjg.js";import{l as _}from"./index-BLRFddlS.js";import"./card-BpfUwd8F.js";import"./house-CjldvkIu.js";import"./axios-KE4dpIQc.js";import"./index-xsH4HHeE.js";function V(){const[x,c]=i.useState(!1),[h]=i.useState("سبب الغاء العملية"),[f,g]=i.useState(""),[r,v]=i.useState(null),o=w(),[E,j]=i.useState(null);i.useEffect(()=>{const e=_("https://paynet-cdji.onrender.com");return j(e),e.on("pendingPaymentsUpdate",n=>{o.setQueryData(["pending-table"],n)}),()=>{e.disconnect()}},[o]);const{data:s,isLoading:k}=Q({queryKey:["pending-table"],queryFn:R}),u=p({mutationFn:e=>C(e),onSuccess:()=>{o.invalidateQueries({queryKey:["pending-table"]})}}),d=p({mutationFn:e=>F(e),onSuccess:()=>{o.invalidateQueries({queryKey:["pending-table"]})}}),m=p({mutationFn:e=>I(e),onSuccess:()=>{o.invalidateQueries({queryKey:["pending-table"]})}}),P=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"landline",label:"الرقم",sortable:!0},{key:"company",label:"الشركة",sortable:!0},{key:"speed",label:"السرعة",sortable:!0},{key:"email",label:"الحساب المرسل",sortable:!0},{key:"amount",label:"المبلغ الواجب دفعه",sortable:!0},{key:"status",label:"حالة العملية",sortable:!0},{key:"createdAt",label:"الوقت",sortable:!0}];i.useEffect(()=>{"Notification"in window&&Notification.requestPermission().then(e=>{console.log("Notification permission:",e)})},[]);const y=i.useRef([]);return i.useEffect(()=>{if(s&&s.length>0){const e=y.current,n=s.filter(a=>!e.some(S=>S._id===a._id));n.length>0&&(new Notification("طلب دفع جديد",{body:`المبلغ: ${n[0].amount} - الشركة: ${n[0].company}`,icon:"/logo.png"}),new Audio("/notification.mp3").play()),y.current=s}},[s]),k?t.jsx(b,{children:t.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):t.jsxs(b,{children:[t.jsx(N,{isOpen:x,setIsOpen:c,title:h,trigger:t.jsx(t.Fragment,{}),children:t.jsx("div",{className:"flex flex-row-reverse gap-2",children:t.jsxs("form",{onSubmit:e=>{e.preventDefault(),r&&(d.mutate({payment:{id:r._id,email:r.email,amount:r.amount},reason:f}),c(!1),g(""))},className:"space-y-4 w-full",children:[t.jsx(q,{dir:"rtl",value:f,onChange:e=>g(e.target.value),type:"text",placeholder:"سبب الرفض (مثال: لا يوجد رصيد)",required:!0}),t.jsx(l,{type:"submit",children:"تأكيد الرفض"})]})})}),t.jsx("div",{dir:"rtl",className:"space-y-6",children:t.jsx(D,{amountBold:!0,title:"تسديدات معلقة",description:"",columns:P,data:s||[],renderRowActions:e=>e.status!="جاري التسديد"?t.jsxs("div",{className:"flex gap-2",children:[t.jsx(l,{variant:"default",size:"sm",onClick:()=>{window.confirm("هل انت متأكد من انهاء العملية")&&u.mutate(e._id)},disabled:u.isPending,children:u.isPending?"...":"تأكيد"}),t.jsx(l,{variant:"destructive",size:"sm",onClick:()=>{v(e),c(!0)},disabled:d.isPending,children:d.isPending?"...":"رفض"})]}):t.jsx(t.Fragment,{children:t.jsx("div",{children:t.jsx(l,{variant:"default",disabled:m.isPending,onClick:()=>{const n=e.landline;let a=n;n.startsWith("033")?a=n.slice(3):n.startsWith("33")&&(a=n.slice(2)),navigator.clipboard.writeText(a),m.mutate(e._id)},children:m.isPending?"...":"بدء التنفيذ"})})})})})]})}export{V as default};
