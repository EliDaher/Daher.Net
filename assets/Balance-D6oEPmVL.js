import{p as O,r as l,h as R,j as e,q as J,i as A}from"./index-BDdD0U4n.js";import{D as X,H as Z}from"./DashboardLayout-Jf3qepeK.js";import{S as D}from"./StatsCard-BrUfVJxX.js";import{C as ee}from"./ChartContainer-Drq3DWDh.js";import{D as B}from"./DataTable-e2tcXuVr.js";import{B as N}from"./button-CkfK7Vl1.js";import{P as K}from"./PopupForm-PnHBliLu.js";import{F as S}from"./FormInput-BnVUfTB4.js";import{u as F}from"./useMutation-695wjy2s.js";import{a as te,d as ne,b as ae,g as se}from"./exchange-CnjiWPPn.js";import{l as Q}from"./index-CtcT9WOL.js";import{f as oe,g as re,h as ie}from"./wifi-oUSI_Hao.js";import{L as le,A as ue,D as de,d as U}from"./DatePicker-C6byVpUz.js";import{u as me,C as E}from"./index.esm-4C7hqibv.js";import{z as k,t as ce}from"./index-paqXoz5o.js";import{S as pe,a as ge,b as he,c as ye,d as L}from"./select-CV3PiMHB.js";import{m as xe}from"./reports-DDVF2P7u.js";import{C as W}from"./credit-card-DfYMHfDb.js";import"./house-ki08jCTb.js";import"./card-VQfqbli1.js";import"./input-cM0YjS2-.js";import"./index-CkVYGzNF.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=O("Coins",[["circle",{cx:"8",cy:"8",r:"6",key:"3yglwk"}],["path",{d:"M18.09 10.37A6 6 0 1 1 10.34 18",key:"t5s6rm"}],["path",{d:"M7 6h1v4",key:"1obek4"}],["path",{d:"m16.71 13.88.7.71-2.82 2.82",key:"1rbuyh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=O("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);function je({isOpen:P,setIsOpen:c,className:p}){const[h,x]=l.useState(0),[g,b]=l.useState(0),[j,f]=l.useState(""),m=R(),y=F({mutationFn:r=>te(r),onSuccess:()=>{m.invalidateQueries({queryKey:["pendingEx"]}),alert("تم الاضافة بمجاح"),v(),c(!1)},onError:()=>{alert("حدث خطأ اثناء الاضافة")}}),n=l.useRef(),v=Q.useReactToPrint({contentRef:n,pageStyle:`
          @page {
            size: 80mm auto;
            margin: 0;
          }
    
          body {
            font-family: 'Arial', sans-serif;
            font-size: 12px;
            padding: 10px;
            color: black;
            direction: rtl;
          }
    
          .header {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
          }
    
          .totalValue {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
          }
    
          .cut {
            page-break-before: always;
            margin-top: 20px;
            text-align: center;
            font-style: italic;
          }
    
          div, span, p {
            break-inside: avoid;
          }
    
          .no-print {
            display: none !important;
          }
        `,onAfterPrint:()=>{console.log("تمت الطباعة بنجاح!"),c(!1)}}),u=()=>{const r=new Date,o={year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"numeric",minute:"numeric",second:"numeric"};return r.toLocaleDateString("en-GB",o)};return e.jsx(K,{isOpen:P,setIsOpen:c,title:"تحويل",trigger:e.jsx(e.Fragment,{children:e.jsx(N,{className:p,variant:"accent",children:"تحويل"})}),children:e.jsxs("form",{onSubmit:r=>{r.preventDefault();let o={sypAmount:Number(h),usdAmount:Number(g),details:j};y.mutate(o)},className:"flex flex-col gap-4",children:[e.jsxs("div",{ref:n,children:[e.jsx("span",{children:u()}),e.jsx(S,{id:"SYPAmount",label:"العملة بالليرة السورية",value:h.toString(),type:"number",onChange:r=>{x(Number(r.target.value))}}),e.jsx(S,{id:"USDAmount",label:"العملة بالدولار",value:g.toString(),type:"number",onChange:r=>{b(Number(r.target.value))}}),e.jsx(S,{id:"exchangeDetails",label:"التفاصيل",value:j.toString(),type:"string",onChange:r=>{f(r.target.value)}})]}),e.jsx(N,{type:"submit",variant:"accent",disabled:y.isPending,children:y.isPending?"...":"تأكيد عملية التحويل"})]})})}function ve({isOpen:P,setIsOpen:c,className:p,SYPAmount:h,USDAmount:x,pendingId:g}){const[b,j]=l.useState(0),[f,m]=l.useState(0),[y,n]=l.useState(""),v=R(),u=F({mutationFn:({id:o})=>ne({id:o}),onSuccess:(o,s)=>{v.invalidateQueries({queryKey:["pendingEx"]}),r.mutate(s.dataToDelete)},onError:()=>{alert("حدث خطأ أثناء الحذف")}}),r=F({mutationFn:o=>ae(o),onSuccess:()=>{v.invalidateQueries({queryKey:["DoneEx"]}),alert("تم الانهاء بمجاح"),c(!1)},onError:()=>{alert("حدث خطأ اثناء الانهاء")}});return e.jsx(K,{isOpen:P,setIsOpen:c,title:"انهاء عملية التحويل",trigger:e.jsx(e.Fragment,{children:e.jsx(N,{className:p,variant:"accent",children:"انهاء عملية التحويل"})}),children:e.jsxs("form",{onSubmit:o=>{o.preventDefault();let s={finalSYP:b,finalUSD:f,sypAmount:Number(h),usdAmount:Number(x),details:y};u.mutate({id:g,dataToDelete:s})},className:"flex flex-col gap-4",children:[e.jsxs("span",{children:["المتوقع ",h," ليرة الى ",x," دولار"]}),e.jsx(S,{id:"finalSYP",label:"العملة بالليرة السورية",value:b.toString(),type:"number",onChange:o=>{j(Number(o.target.value))}}),e.jsx(S,{id:"finalUSD",label:"العملة بالدولار",value:f.toString(),type:"number",onChange:o=>{m(Number(o.target.value))}}),e.jsx(S,{id:"exchangeDetails",label:"التفاصيل",value:y.toString(),type:"string",onChange:o=>{n(o.target.value)}}),e.jsx(N,{type:"submit",variant:"accent",disabled:r.isPending||u.isPending,children:r.isPending||u.isPending?"...":"تأكيد عملية التحويل"})]})})}const Se=k.object({amount:k.number({invalid_type_error:"القيمة مطلوبة"}).positive("يجب أن تكون القيمة أكبر من 0"),date:k.any().nullable(),type:k.enum(["cash","shamCash"]),details:k.string().optional()}),Pe=({isOpen:P,setIsOpen:c,formTitle:p})=>{const h=l.useRef(null),x=R(),{control:g,handleSubmit:b,reset:j,watch:f,formState:{errors:m,isSubmitting:y}}=me({resolver:ce(Se),defaultValues:{amount:0,date:null,details:""}}),n=f("amount"),v=f("details"),u=F({mutationFn:oe,onSuccess:()=>{alert("✅ تمت إضافة الدفعة."),x.invalidateQueries({queryKey:["balance-table"]}),j(),c(!1)},onError:()=>{alert("❌ حدث خطأ أثناء الإرسال.")}}),r=Q.useReactToPrint({contentRef:h,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body { direction: rtl; font-size: 12px; }
      .no-print { display: none !important; }
    `}),o=s=>{window.confirm("هل تريد طباعة ايصال ؟")&&r(),u.mutate({amount:p==="اضافة دفعة الى الصندوق"?s.amount:-s.amount,date:s.date?U(s.date).format("YYYY-MM-DD"):"",details:s.details||"",type:s.type||"cash"})};return e.jsx(K,{isOpen:P,setIsOpen:c,title:p,trigger:e.jsx(e.Fragment,{}),children:e.jsxs("div",{className:"p-2",children:[e.jsxs("form",{onSubmit:b(o),className:"space-y-4 w-full",children:[e.jsx(E,{name:"amount",control:g,render:({field:s})=>{var C;return e.jsx(S,{label:"",...s,type:"number",placeholder:"القيمة بالدولار",error:(C=m.amount)==null?void 0:C.message})}}),e.jsx(le,{dateAdapter:ue,children:e.jsx(E,{name:"date",control:g,render:({field:s})=>e.jsx(de,{className:"w-full",label:"اختر التاريخ",format:"DD/MM/YYYY",...s})})}),e.jsx(E,{name:"details",control:g,render:({field:s})=>e.jsx(S,{label:"",...s,type:"text",placeholder:"تفاصيل (اختياري)"})}),e.jsx(E,{name:"type",control:g,render:({field:s})=>e.jsxs(pe,{value:s.value,onValueChange:s.onChange,children:[e.jsx(ge,{children:e.jsx(he,{placeholder:"نوع الدفع"})}),e.jsxs(ye,{children:[e.jsx(L,{value:"none",disabled:!0,children:"اختر نوع الدفع"}),e.jsx(L,{value:"cash",children:"Cash"}),e.jsx(L,{value:"shamCash",children:"Sham Cash"})]})]})}),e.jsx("button",{type:"submit",disabled:y||u.isPending,className:"w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition",children:u.isPending?"جارٍ الحفظ...":"حفظ"})]}),e.jsxs("div",{ref:h,className:"sr-only",dir:"rtl",children:[e.jsx("h2",{className:"text-center font-bold",children:"Daher.Net"}),e.jsx("p",{children:U().format("DD/MM/YYYY HH:mm")}),e.jsxs("div",{className:"mt-2",children:[e.jsx("strong",{children:"التفاصيل:"}),e.jsx("p",{children:v||"بدون ملاحظات"})]}),e.jsxs("div",{className:"mt-4 font-bold",children:[p,": ",n," $"]})]})]})})};function Ve(){var I;const P=J(),[c,p]=l.useState(!1),[h,x]=l.useState(""),[g,b]=l.useState(!1),[j,f]=l.useState(null),{data:m,isLoading:y}=A({queryKey:["customers-table"],queryFn:re}),{data:n,isLoading:v}=A({queryKey:["balance-table"],queryFn:ie}),{data:u,isLoading:r}=A({queryKey:["pending-exchange"],queryFn:se}),{data:o}=A({queryKey:["monthly-revenue"],queryFn:xe}),s=l.useMemo(()=>{const t={cash:{total:0,count:0},shamCash:{total:0,count:0},other:{total:0,count:0}};return n!=null&&n.WifiPayments&&(n.WifiPayments.forEach(a=>{const d=Number(a.Amount)||0,i=a.type;i==="cash"||i==="shamCash"?(t[i].total+=d,t[i].count+=1):(t.other.total+=d,t.other.count+=1)}),n.WifiBalance.forEach(a=>{const d=Number(a.Amount)||0,i=a.type;i==="cash"||i==="shamCash"?(t[i].total+=d,t[i].count+=1):(t.other.total+=d,t.other.count+=1)})),t},[n]),C=l.useMemo(()=>m==null?void 0:m.reduce((t,a)=>(t[String(a.id)]=a,t),{}),[m]),V=l.useMemo(()=>{const t=(m==null?void 0:m.filter(a=>Number(a.Balance)<0).reduce((a,d)=>a+Number(d.Balance),0))??0;return Math.abs(t)},[m]),M=l.useMemo(()=>{var d,i;if(!n)return 0;const t=((d=n.WifiBalance)==null?void 0:d.reduce((T,q)=>T+Number(q.amount),0))??0,a=((i=n.WifiPayments)==null?void 0:i.reduce((T,q)=>T+Number(q.Amount),0))??0;return t+a},[n]),Y=new Date,{monthTotal:w,todayTotal:H}=l.useMemo(()=>{if(!(n!=null&&n.WifiPayments))return{monthTotal:0,todayTotal:0};let t=0,a=0;return n.WifiPayments.forEach(d=>{const i=new Date(d.Date);i.getFullYear()===Y.getFullYear()&&i.getMonth()===Y.getMonth()&&(t+=Number(d.Amount),i.getDate()===Y.getDate()&&(a+=Number(d.Amount)))}),{monthTotal:t,todayTotal:a}},[n]),z=l.useMemo(()=>{var d;let t=0,a=0;return(d=u==null?void 0:u.pendingList)==null||d.forEach(i=>{t+=i.sypAmount||0,a+=i.usdAmount||0}),{syp:t,usd:a}},[u]),_=[{key:"amount",label:"الكمية",sortable:!0},{key:"details",label:"التفاصيل",sortable:!0},{key:"timestamp",label:"الوقت",sortable:!0}],G=[{key:"Amount",label:"الكمية",sortable:!0},{key:"customerName",label:"اسم الزبون",sortable:!0},{key:"type",label:"طريقة الدفع",sortable:!0},{key:"Details",label:"التفاصيل",sortable:!0},{key:"Date",label:"الوقت",sortable:!0}],$=[{key:"id",label:"ID",hidden:!0},{key:"sypAmount",label:"السوري",sortable:!0},{key:"usdAmount",label:"دولار",sortable:!0},{key:"details",label:"التفاصيل",sortable:!0},{key:"timestamp",label:"الوقت",sortable:!0}];return e.jsxs(X,{children:[e.jsx(Pe,{isOpen:c,setIsOpen:p,formTitle:h}),e.jsxs("div",{dir:"rtl",className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx(D,{className:"rounded-b-none",title:"الرصيد الحالي",value:M,icon:be,trend:{value:M-w,isPositive:M-w>0},loading:v}),e.jsxs("div",{className:"flex",children:[e.jsx(N,{className:"w-1/2 rounded-l-none rounded-t-none",onClick:()=>{x("إضافة دفعة إلى الصندوق"),p(!0)},children:"إضافة"}),e.jsx(N,{variant:"destructive",className:"w-1/2 rounded-r-none rounded-t-none",onClick:()=>{x("دفع من الصندوق"),p(!0)},children:"سحب"})]})]}),e.jsx(D,{title:"إيرادات هذا الشهر",value:w,icon:W,trend:{value:H,isPositive:!0}}),e.jsx(D,{title:"مقبوضات الشام كاش",value:s.shamCash.total,icon:W}),e.jsx(D,{title:"مقبوضات كاش",value:s.cash.total,icon:W}),e.jsx(D,{title:"الديون",value:V,icon:Z,loading:y,onClick:()=>P("/users",{state:"unpaid"})}),e.jsxs("div",{children:[e.jsx(D,{className:"rounded-b-none",title:"للتحويل",value:z.syp,icon:fe,trend:{value:z.usd,isPositive:!1},loading:r}),e.jsx(je,{className:"rounded-t-none",isOpen:g,setIsOpen:b})]})]}),e.jsx(ee,{title:"الحركة المالية",type:"area",dataKey:"الفواتير",dataKey2:"المدفوعات",data:o?Object.entries(o).map(([t,a])=>({name:t,الفواتير:a.invoices,المدفوعات:a.payments})):[]}),e.jsxs("div",{dir:"rtl",className:"flex flex-col md:flex-row gap-4",children:[e.jsx(B,{title:"الصندوق",columns:_,data:[...(n==null?void 0:n.WifiBalance)??[]].reverse()}),e.jsx(B,{title:"الدفعات",columns:G,data:((I=n==null?void 0:n.WifiPayments)==null?void 0:I.map(t=>{var a;return{...t,customerName:((a=C==null?void 0:C[String(t.SubscriberID)])==null?void 0:a.Name)||"غير معروف"}}).reverse())??[]}),e.jsx(B,{title:"دفعات للتحويل",columns:$,data:(u==null?void 0:u.pendingList)??[],renderRowActions:t=>e.jsx(ve,{className:"",isOpen:j===t.id,setIsOpen:a=>f(a?t.id:null),SYPAmount:t.sypAmount,USDAmount:t.usdAmount,pendingId:t.id})})]})]})}export{Ve as default};
