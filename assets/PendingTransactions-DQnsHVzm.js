import{k as D,V as Q,v as p,j as e,s as M,F,W as T,B as d,X as E,Y as O,r as i,l as R,D as B,w as K,p as _,Z as U}from"./index-ChThjnzq.js";import{c as W,r as A,s as L,g as z}from"./invoices-CRJphiBP.js";import{l as J}from"./index-BLRFddlS.js";function V({isOpen:c,setIsOpen:h}){var g,x;const j=JSON.parse(localStorage.getItem("DaherUser")),v=D(),u=["512 Mbps - 14000","1 Mbps - 18500","2 Mbps - 24000","4 Mbps - 38000","8 Mbps - 64000","16 Mbps - 83000","البرونزية - 17500","العائلية - 22000","الذهبية - 29000","5 GB - 1800","10 GB - 3300","20 GB - 5700","30 GB - 7600","50 GB - 11500","75 GB - 13500","100 GB - 19000","200 GB - 35000"],S=["ناس","برونت","اينت","رنت","الكم","ليما","سوا","اية","يارا","بطاقات","هايبر","ويف","امنية","فيو","ليزر","متس","سما","زاد","دنيا","هاي فاي","تكامل","لاين","الجمعية"],{register:m,handleSubmit:b,reset:l,control:y,formState:{errors:a}}=Q({defaultValues:{landline:"",selectedCompany:"",selectedSpeed:"",amountToPay:0,paymentType:"cash",email:j.username+"Ddaheradmin"}}),f=p({mutationFn:n=>E({formData:n}),onSuccess:()=>{v.invalidateQueries({queryKey:["pending-table"]}),l(),h(!1)},onError:()=>{alert("حدث خطأ أثناء إرسال الطلب")}}),N=n=>{f.mutate(n)};return e.jsx(M,{isOpen:c,setIsOpen:h,title:"إرسال رقم للتسديد",trigger:e.jsx(d,{className:"absolute bottom-8 right-8 z-50",children:"إرسال رقم للتسديد"}),children:e.jsxs("form",{onSubmit:b(N),className:"space-y-4",children:[e.jsx(F,{id:"landline",label:"رقم الهاتف / الخط",...m("landline",{required:"الرقم مطلوب"}),error:(g=a.landline)==null?void 0:g.message}),e.jsx(T,{name:"selectedCompany",control:y,rules:{required:"يرجى اختيار الشركة"},render:({field:n})=>e.jsxs("div",{dir:"rtl",className:"flex flex-col",children:[e.jsx("label",{className:"mb-1 mr-3 font-medium",children:"الشركة"}),e.jsxs("select",{...n,className:"border border-gray-300 p-2 bg-background rounded",children:[e.jsx("option",{value:"",children:"اختر الشركة"}),S.map(o=>e.jsx("option",{value:o,children:o},o))]}),a.selectedCompany&&e.jsx("span",{className:"text-red-500 text-sm mt-1",children:a.selectedCompany.message})]})}),e.jsx(T,{name:"selectedSpeed",control:y,rules:{required:"يرجى اختيار السرعة"},render:({field:n})=>e.jsxs("div",{dir:"rtl",className:"flex flex-col",children:[e.jsx("label",{className:"mb-1 mr-3 font-medium",children:"السرعة"}),e.jsxs("select",{...n,className:"border border-gray-300 p-2 bg-background rounded",children:[e.jsx("option",{value:"",children:"اختر السرعة"}),u.map(o=>e.jsx("option",{value:o,children:o},o))]}),a.selectedSpeed&&e.jsx("span",{className:"text-red-500 text-sm mt-1",children:a.selectedSpeed.message})]})}),e.jsx(F,{id:"amountToPay",label:"المبلغ المطلوب",type:"number",...m("amountToPay",{valueAsNumber:!0,required:"المبلغ مطلوب",min:{value:1,message:"المبلغ غير صالح"}}),error:(x=a.amountToPay)==null?void 0:x.message}),e.jsx(d,{type:"submit",className:"w-full mt-4",disabled:f.isPending,children:f.isPending?"جاري الإرسال...":"إرسال للتسديد"})]})})}function Z(){const{data:c,isLoading:h}=O(),j=JSON.parse(localStorage.getItem("DaherUser"));i.useEffect(()=>{console.log(c)},[]);const[v,u]=i.useState(!1),[S]=i.useState("سبب الغاء العملية"),[m,b]=i.useState(""),[l,y]=i.useState(null),a=D(),[f,N]=i.useState(null),[g,x]=i.useState(!1);i.useEffect(()=>{const t=J("https://paynet-1.onrender.com");return N(t),t.on("pendingPaymentsUpdate",s=>{a.setQueryData(["pending-table"],s)}),()=>{t.disconnect()}},[a]);const{data:n,isLoading:o}=R({queryKey:["pending-table"],queryFn:z}),P=p({mutationFn:t=>W(t),onSuccess:()=>{a.invalidateQueries({queryKey:["pending-table"]})}}),I=p({mutationFn:t=>U(t),onSuccess:()=>{a.invalidateQueries({queryKey:["pending-table"]})}}),k=p({mutationFn:t=>A(t),onSuccess:()=>{a.invalidateQueries({queryKey:["pending-table"]})}}),C=p({mutationFn:t=>L(t),onSuccess:()=>{a.invalidateQueries({queryKey:["pending-table"]})}}),w=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"landline",label:"الرقم",sortable:!0},{key:"company",label:"الشركة",sortable:!0},{key:"speed",label:"السرعة",sortable:!0},{key:"email",label:"الحساب المرسل",sortable:!0},{key:"amount",label:"المبلغ الواجب دفعه",sortable:!0},{key:"status",label:"حالة العملية",sortable:!0},{key:"createdAt",label:"الوقت",sortable:!0}];i.useEffect(()=>{"Notification"in window&&Notification.requestPermission().then(t=>{console.log("Notification permission:",t)})},[]);const q=i.useRef([]);return i.useEffect(()=>{if(n&&n.length>0){const t=q.current,s=n.filter(r=>!t.some(G=>G._id===r._id));s.length>0&&(new Notification("طلب دفع جديد",{body:`المبلغ: ${s[0].amount} - الشركة: ${s[0].company}`,icon:"/logo.png"}),new Audio("/notification.mp3").play()),q.current=n}},[n]),o?e.jsx(B,{children:e.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):e.jsxs(B,{children:[e.jsx(V,{isOpen:g,setIsOpen:x}),e.jsx(M,{isOpen:v,setIsOpen:u,title:S,trigger:e.jsx(e.Fragment,{}),children:e.jsx("div",{className:"flex flex-row-reverse gap-2",children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),l&&(k.mutate({payment:{id:l._id,email:l.email,amount:l.amount},reason:m}),u(!1),b(""))},className:"space-y-4 w-full",children:[e.jsx(K,{dir:"rtl",value:m,onChange:t=>b(t.target.value),type:"text",placeholder:"سبب الرفض (مثال: لا يوجد رصيد)",required:!0}),e.jsx(d,{type:"submit",children:"تأكيد الرفض"})]})})}),e.jsx("div",{dir:"rtl",className:"space-y-6",children:e.jsx(_,{amountBold:!0,title:"تسديدات معلقة",description:"",totalPend:!0,columns:w,data:n||[],renderRowActions:t=>t.status!="جاري التسديد"?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"default",size:"sm",onClick:()=>{var s;window.confirm("هل انت متأكد من انهاء العملية")&&(P.mutate(t._id),I.mutate({amount:t.amount,reason:"",company:t.company,number:t.number,companyId:c?(s=c.find(r=>r.name===t.company))==null?void 0:s.id:"",port:j.username}))},disabled:P.isPending,children:P.isPending?"...":"تأكيد"}),e.jsx(d,{variant:"destructive",size:"sm",onClick:()=>{y(t),u(!0)},disabled:k.isPending,children:k.isPending?"...":"رفض"})]}):e.jsx(e.Fragment,{children:e.jsx("div",{children:e.jsx(d,{variant:"default",disabled:C.isPending,onClick:()=>{const s=t.landline;let r=s;s.startsWith("033")?r=s.slice(3):s.startsWith("33")&&(r=s.slice(2)),s.startsWith("013")?r=s.slice(3):s.startsWith("13")&&(r=s.slice(2)),navigator.clipboard.writeText(r),C.mutate(t._id)},children:C.isPending?"...":"بدء التنفيذ"})})})})})]})}export{Z as default};
