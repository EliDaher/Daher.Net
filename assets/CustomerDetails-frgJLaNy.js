import{p as U,r as n,h as H,j as e,x as O,q as _,t as J,i as F}from"./index-DjtrOvVI.js";import{D as E}from"./DashboardLayout-BHIEqfHp.js";import{C as R,a as W,b as G,c as X}from"./card-CLiHiovH.js";import{B as h}from"./button-BK6lVoHu.js";import{S as Z,D as ee}from"./DataTable-BcblhkSS.js";import{b as te,c as ae,e as se}from"./wifi-DIPZTrYu.js";import{D as re}from"./DetailsInputs-BvhptLYl.js";import{l as V}from"./index-CDiTZOg0.js";import{P as ne,m as L,A as ie}from"./PopupForm-D1G_mMS6.js";import{d as k,L as le,A as oe,D as de}from"./DatePicker--xSki6Gm.js";import{u as ce,C as w}from"./index.esm-BT84-3Mz.js";import{z as g,t as me}from"./index-DQudpRVX.js";import{F as A}from"./FormInput-CYE56ifK.js";import{S as M,a as K,b as Q,c as T,d as x}from"./select-_uiUeovW.js";import{u as z}from"./useMutation-BHAbwPe4.js";import{a as ue}from"./exchange-BkFNmioM.js";import{A as xe}from"./arrow-left-COftB-PC.js";import{P as I}from"./plus-DJ-5H6DU.js";import"./house-C1D2S_pc.js";import"./input-DK-39AZO.js";import"./index-BMhVl2ff.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=U("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),pe=g.object({amount:g.coerce.number({invalid_type_error:"القيمة مطلوبة"}),date:g.any().nullable(),type:g.enum(["cash","shamCash"]),details:g.string().optional()}),fe=({isOpen:l,setIsOpen:p,formTitle:q,printOnly:i=!1,customer:a})=>{const c=n.useRef(null),r=H(),[f,y]=n.useState("USD"),[j,b]=n.useState(0),{control:o,handleSubmit:v,watch:s,formState:{errors:C,isSubmitting:m},reset:D}=ce({resolver:me(pe),defaultValues:{amount:0,date:k(),details:"",type:"cash"}}),Y=s("amount"),S=s("details"),N=s("type"),P=V.useReactToPrint({contentRef:c,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body { font-family: Arial; font-size: 12px; direction: rtl; }
    `}),d=()=>k().format("DD/MM/YYYY HH:mm"),u=z({mutationFn:te,onSuccess:()=>{r.invalidateQueries({queryKey:["balance-table"]}),r.invalidateQueries({queryKey:["customer",a.id]}),r.invalidateQueries({queryKey:["transactions",a.id]}),window.confirm("هل تريد طباعة إيصال؟")&&P(),D(),p(!1)},onError:()=>{alert("❌ حدث خطأ أثناء تسجيل الدفعة")}}),$=z({mutationFn:t=>ue(t),onSuccess:()=>{r.invalidateQueries({queryKey:["pendingEx"]}),r.invalidateQueries({queryKey:["balance-table"]}),r.invalidateQueries({queryKey:["customer",a.id]}),r.invalidateQueries({queryKey:["transactions",a.id]}),alert("تم الاضافة بمجاح"),P(),p(!1)},onError:()=>{alert("حدث خطأ اثناء الاضافة")}}),B=t=>{if(!(a!=null&&a.id)){alert("❌ المشترك غير معروف");return}window.confirm(`تأكيد تسجيل دفعة بقيمة ${t.amount}$ ؟`)&&(u.mutate({amount:t.amount,date:k(t.date).format("YYYY-MM-DD"),details:t.details,subscriberID:a.id,total:a.Balance??0,type:t.type}),f=="SYP"&&$.mutate({sypAmount:j,usdAmount:t.amount,details:t.details}))};return e.jsx(ne,{trigger:e.jsx(e.Fragment,{}),isOpen:l,setIsOpen:p,title:q,children:e.jsxs("div",{className:"flex flex-row-reverse gap-4",children:[!i&&e.jsxs(L.form,{layout:!0,onSubmit:v(B),className:"space-y-4 w-full",transition:{layout:{duration:.45,ease:[.22,1,.36,1]}},children:[e.jsx(w,{name:"amount",control:o,render:({field:t})=>e.jsx(A,{label:"القيمة بالدولار",...t,type:"number",placeholder:"Ex: 8"})}),C.amount&&e.jsx("p",{className:"text-red-500 text-sm",children:C.amount.message}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(w,{name:"type",control:o,render:({field:t})=>e.jsxs(M,{value:t.value,onValueChange:t.onChange,children:[e.jsx(K,{children:e.jsx(Q,{placeholder:"نوع الدفع"})}),e.jsxs(T,{children:[e.jsx(x,{value:"none",disabled:!0,children:"اختر نوع الدفع"}),e.jsx(x,{value:"cash",children:"Cash"}),e.jsx(x,{value:"shamCash",children:"Sham Cash"})]})]})}),e.jsxs(M,{value:f,onValueChange:t=>y(t),children:[e.jsx(K,{children:e.jsx(Q,{placeholder:"العملة"})}),e.jsxs(T,{children:[e.jsx(x,{value:"none",disabled:!0,children:"اختر نوع العملة المدفوع بها"}),e.jsx(x,{value:"USD",children:"USD"}),e.jsx(x,{value:"SYP",children:"SYP"})]})]})]}),e.jsx(ie,{children:f==="SYP"&&e.jsx(L.div,{layout:!0,initial:{opacity:0,scale:.96,y:-8,filter:"blur(6px)"},animate:{opacity:1,scale:1,y:0,filter:"blur(0px)"},exit:{opacity:0,scale:.96,y:-8,filter:"blur(6px)"},transition:{type:"spring",stiffness:260,damping:22},className:"overflow-hidden rounded-xl border border-border/40 bg-background/60 backdrop-blur-md p-3 shadow-sm",children:e.jsx(A,{label:"القيمة بالليرة السورية",type:"number",placeholder:"Ex: 100000",value:j,onChange:t=>b(Number(t.target.value))})},"syp-field")}),e.jsx(le,{dateAdapter:oe,children:e.jsx(w,{name:"date",control:o,render:({field:t})=>e.jsx(de,{className:"text-foreground",...t,format:"DD/MM/YYYY"})})}),e.jsx(w,{name:"details",control:o,render:({field:t})=>e.jsx(A,{label:"التفاصيل",...t,type:"text",placeholder:""})}),e.jsx(h,{loading:u.isPending,type:"submit",disabled:m||u.isPending,className:"w-full",children:u.isPending?"جاري الحفظ...":"تأكيد الدفع"})]}),e.jsxs("div",{ref:c,className:"sr-only p-4 text-sm",dir:"rtl",children:[e.jsxs("div",{className:"text-center font-bold",children:[e.jsx("h1",{children:"Daher.Net"}),e.jsx("span",{children:d()})]}),e.jsxs("div",{className:"mt-2 font-bold",children:[e.jsxs("div",{children:["الاسم: ",a==null?void 0:a.Name]}),e.jsxs("div",{children:["الرقم: ",a==null?void 0:a.Contact]})]}),e.jsxs("div",{className:"mt-2",children:["نوع الدفع: ",N]}),e.jsxs("div",{className:"mt-2",children:["التفاصيل: ",S||"—"]}),e.jsxs("div",{className:"mt-4 border-t pt-2 font-extrabold",children:["المبلغ: ",Y," $"]})]})]})})};function Te(){const{id:l}=O(),p=_(),i=J().state,a=JSON.parse(localStorage.getItem("DaherUser")||"{}"),[c,r]=n.useState(!1),[f,y]=n.useState(""),[j,b]=n.useState(!1),[o,v]=n.useState(null),{data:s,isLoading:C}=F({queryKey:["customer",l],queryFn:()=>ae(l),enabled:!!l}),{data:m,isLoading:D}=F({queryKey:["transactions",l],queryFn:()=>se(l),enabled:!!l});n.useEffect(()=>{s&&v({...s,address:(i==null?void 0:i.address)||""})},[s,i]);const Y=()=>{if(!(s!=null&&s.Contact)){alert("لا يوجد رقم هاتف للمشترك");return}if(s.Balance>=0){alert("لا يوجد عليه فواتير");return}const d=s.Contact.replace(/\D/g,""),u=`عزيزي المشترك ${s.Name}، قيمة فاتورتك الحالية هي: ${s.Balance*-1} دولار.
يرجى التسديد قبل تاريخ 5-2-2026 لضمان استمرار الخدمة دون انقطاع.
شكرًا لثقتك بخدماتنا.`;window.open(`https://wa.me/${d}?text=${encodeURIComponent(u)}`,"_blank")},S=n.useRef(null),N=V.useReactToPrint({contentRef:S,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body {
        font-family: Arial;
        font-size: 12px;
        direction: rtl;
      }
      .no-print { display: none !important; }
    `,onAfterPrint:()=>r(!1)});if(n.useEffect(()=>{c&&j&&N()},[c,j,N]),C||!o)return e.jsx(E,{children:e.jsx(Z,{className:"h-64 w-full"})});const P=[{key:"amount",label:"الكمية",sortable:!0},{key:"Details",label:"التفاصيل",sortable:!0},{key:"date",label:"الوقت",sortable:!0}];return e.jsxs(E,{children:[e.jsx(fe,{isOpen:c,setIsOpen:r,formTitle:f,customer:{...s,address:(i==null?void 0:i.address)||""}}),e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات المشترك"}),e.jsxs(h,{onClick:()=>p("/users"),variant:"outline",children:[e.jsx(xe,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(R,{children:[e.jsx(W,{children:e.jsx(G,{children:"المعلومات الأساسية"})}),e.jsx(X,{children:e.jsx(re,{customer:o,setCustomer:v})})]}),e.jsxs("div",{className:"flex justify-start gap-2",children:[a.role==="admin"&&e.jsxs(h,{variant:"destructive",onClick:()=>{y("اضافة فاتورة"),b(!1),r(!0)},children:[e.jsx(I,{className:"w-4 h-4 ml-2"})," اصدار فاتورة"]}),e.jsxs(h,{onClick:()=>{y("اضافة دفعة"),b(!1),r(!0)},children:[e.jsx(I,{className:"w-4 h-4 ml-2"})," إضافة دفعة"]}),e.jsx(h,{variant:"outline",onClick:Y,children:"واتساب"})]}),e.jsx(R,{className:"overflow-x-auto",ref:S,children:(m==null?void 0:m.length)===0?e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."}):e.jsx(ee,{title:"البيان المالي",columns:P,data:m||[],defaultPageSize:5,getRowClassName:d=>d.type!=="payment"?"text-red-500":"text-green-500",renderRowActions:d=>e.jsx(h,{variant:"outline",onClick:()=>{y(d.type==="payment"?"اضافة دفعة":"اضافة فاتورة"),b(!0),r(!0)},children:e.jsx(he,{})}),isLoading:D})})]})]})}export{Te as default};
