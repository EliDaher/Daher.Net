import{r as l,e as K,j as e,J as C,m as X,f as E}from"./index-DeUUlL9l.js";import{D as Z,H as ee}from"./DashboardLayout-BPlQhhSI.js";import{S as N}from"./StatsCard-DLrksVhG.js";import{C as te}from"./ChartContainer-CLdluTNf.js";import{D as L}from"./DataTable-BqyNnvuC.js";import{a as Q,B as k}from"./button-BbuLOj8Q.js";import{P as z}from"./PopupForm-D19z1y7r.js";import{F as S}from"./FormInput-CGbfZ7w7.js";import{u as M}from"./useMutation-koEyhcvW.js";import{a as ne,d as ae,b as se,g as oe}from"./exchange-ZmmnGVlN.js";import{l as V}from"./index-CnfUKFJY.js";import{f as re,g as ie,h as le}from"./wifi-D_fU9QAN.js";import{L as ue,A as ce,D as de,d as O}from"./DatePicker-BAQgg1Xq.js";import{u as me,C as F}from"./index.esm-DcIbs3al.js";import{z as A,t as pe}from"./index-Cs13h3DU.js";import{S as ge,a as he,b as ye,c as xe,d as W}from"./select-l1Jz9fj2.js";import{m as fe}from"./reports-BxMVztK8.js";import{C as R}from"./credit-card-DJWNdhIw.js";import"./house-tY2-Z_zD.js";import"./card-B7FlCwkI.js";import"./input-BSkmp32h.js";import"./index-BpLVn6uf.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=Q("Coins",[["circle",{cx:"8",cy:"8",r:"6",key:"3yglwk"}],["path",{d:"M18.09 10.37A6 6 0 1 1 10.34 18",key:"t5s6rm"}],["path",{d:"M7 6h1v4",key:"1obek4"}],["path",{d:"m16.71 13.88.7.71-2.82 2.82",key:"1rbuyh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=Q("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);function ve({isOpen:P,setIsOpen:m,className:p}){const[h,x]=l.useState(0),[g,b]=l.useState(0),[j,f]=l.useState(""),d=K(),y=M({mutationFn:r=>ne(r),onSuccess:()=>{d.invalidateQueries({queryKey:["pendingEx"]}),C.success("تم الاضافة بمجاح"),v(),m(!1)},onError:()=>{C.error("حدث خطأ اثناء الاضافة")}}),n=l.useRef(),v=V.useReactToPrint({contentRef:n,pageStyle:`
          @page {
            size: 80mm auto;
            margin: 0;
          }
    
          body {
            font-family: 'Arial', sans-serif;
            font-size: 12px;
            padding: 10px;
            color: black;
            direction: rtl;
          }
    
          .header {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
          }
    
          .totalValue {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
          }
    
          .cut {
            page-break-before: always;
            margin-top: 20px;
            text-align: center;
            font-style: italic;
          }
    
          div, span, p {
            break-inside: avoid;
          }
    
          .no-print {
            display: none !important;
          }
        `,onAfterPrint:()=>{console.log("تمت الطباعة بنجاح!"),m(!1)}}),u=()=>{const r=new Date,o={year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"numeric",minute:"numeric",second:"numeric"};return r.toLocaleDateString("en-GB",o)};return e.jsx(z,{isOpen:P,setIsOpen:m,title:"تحويل",trigger:e.jsx(e.Fragment,{children:e.jsx(k,{className:p,variant:"accent",children:"تحويل"})}),children:e.jsxs("form",{onSubmit:r=>{r.preventDefault();let o={sypAmount:Number(h),usdAmount:Number(g),details:j};y.mutate(o)},className:"flex flex-col gap-4",children:[e.jsxs("div",{ref:n,children:[e.jsx("span",{children:u()}),e.jsx(S,{id:"SYPAmount",label:"العملة بالليرة السورية",value:h.toString(),type:"number",onChange:r=>{x(Number(r.target.value))}}),e.jsx(S,{id:"USDAmount",label:"العملة بالدولار",value:g.toString(),type:"number",onChange:r=>{b(Number(r.target.value))}}),e.jsx(S,{id:"exchangeDetails",label:"التفاصيل",value:j.toString(),type:"string",onChange:r=>{f(r.target.value)}})]}),e.jsx(k,{type:"submit",variant:"accent",disabled:y.isPending,children:y.isPending?"...":"تأكيد عملية التحويل"})]})})}function Se({isOpen:P,setIsOpen:m,className:p,SYPAmount:h,USDAmount:x,pendingId:g}){const[b,j]=l.useState(0),[f,d]=l.useState(0),[y,n]=l.useState(""),v=K(),u=M({mutationFn:({id:o})=>ae({id:o}),onSuccess:(o,s)=>{v.invalidateQueries({queryKey:["pendingEx"]}),r.mutate(s.dataToDelete)},onError:()=>{C.error("حدث خطأ أثناء الحذف")}}),r=M({mutationFn:o=>se(o),onSuccess:()=>{v.invalidateQueries({queryKey:["DoneEx"]}),C.success("تم الانهاء بمجاح"),m(!1)},onError:()=>{C.error("حدث خطأ اثناء الانهاء")}});return e.jsx(z,{isOpen:P,setIsOpen:m,title:"انهاء عملية التحويل",trigger:e.jsx(e.Fragment,{children:e.jsx(k,{className:p,variant:"accent",children:"انهاء عملية التحويل"})}),children:e.jsxs("form",{onSubmit:o=>{o.preventDefault();let s={finalSYP:b,finalUSD:f,sypAmount:Number(h),usdAmount:Number(x),details:y};u.mutate({id:g,dataToDelete:s})},className:"flex flex-col gap-4",children:[e.jsxs("span",{children:["المتوقع ",h," ليرة الى ",x," دولار"]}),e.jsx(S,{id:"finalSYP",label:"العملة بالليرة السورية",value:b.toString(),type:"number",onChange:o=>{j(Number(o.target.value))}}),e.jsx(S,{id:"finalUSD",label:"العملة بالدولار",value:f.toString(),type:"number",onChange:o=>{d(Number(o.target.value))}}),e.jsx(S,{id:"exchangeDetails",label:"التفاصيل",value:y.toString(),type:"string",onChange:o=>{n(o.target.value)}}),e.jsx(k,{type:"submit",variant:"accent",disabled:r.isPending||u.isPending,children:r.isPending||u.isPending?"...":"تأكيد عملية التحويل"})]})})}const Pe=A.object({amount:A.number({invalid_type_error:"القيمة مطلوبة"}).positive("يجب أن تكون القيمة أكبر من 0"),date:A.any().nullable(),type:A.enum(["cash","shamCash"]),details:A.string().optional()}),Ce=({isOpen:P,setIsOpen:m,formTitle:p})=>{const h=l.useRef(null),x=K(),{control:g,handleSubmit:b,reset:j,watch:f,formState:{errors:d,isSubmitting:y}}=me({resolver:pe(Pe),defaultValues:{amount:0,date:null,details:""}}),n=f("amount"),v=f("details"),u=M({mutationFn:re,onSuccess:()=>{C.success("✅ تمت إضافة الدفعة."),x.invalidateQueries({queryKey:["balance-table"]}),j(),m(!1)},onError:()=>{C.error("❌ حدث خطأ أثناء الإرسال.")}}),r=V.useReactToPrint({contentRef:h,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body { direction: rtl; font-size: 12px; }
      .no-print { display: none !important; }
    `}),o=s=>{window.confirm("هل تريد طباعة ايصال ؟")&&r(),u.mutate({amount:p==="اضافة دفعة الى الصندوق"?s.amount:-s.amount,date:s.date?O(s.date).format("YYYY-MM-DD"):"",details:s.details||"",type:s.type||"cash"})};return e.jsx(z,{isOpen:P,setIsOpen:m,title:p,trigger:e.jsx(e.Fragment,{}),children:e.jsxs("div",{className:"p-2",children:[e.jsxs("form",{onSubmit:b(o),className:"space-y-4 w-full",children:[e.jsx(F,{name:"amount",control:g,render:({field:s})=>{var D;return e.jsx(S,{label:"",...s,type:"number",placeholder:"القيمة بالدولار",error:(D=d.amount)==null?void 0:D.message})}}),e.jsx(ue,{dateAdapter:ce,children:e.jsx(F,{name:"date",control:g,render:({field:s})=>e.jsx(de,{className:"w-full",label:"اختر التاريخ",format:"DD/MM/YYYY",...s})})}),e.jsx(F,{name:"details",control:g,render:({field:s})=>e.jsx(S,{label:"",...s,type:"text",placeholder:"تفاصيل (اختياري)"})}),e.jsx(F,{name:"type",control:g,render:({field:s})=>e.jsxs(ge,{value:s.value,onValueChange:s.onChange,children:[e.jsx(he,{children:e.jsx(ye,{placeholder:"نوع الدفع"})}),e.jsxs(xe,{children:[e.jsx(W,{value:"none",disabled:!0,children:"اختر نوع الدفع"}),e.jsx(W,{value:"cash",children:"Cash"}),e.jsx(W,{value:"shamCash",children:"Sham Cash"})]})]})}),e.jsx("button",{type:"submit",disabled:y||u.isPending,className:"w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition",children:u.isPending?"جارٍ الحفظ...":"حفظ"})]}),e.jsxs("div",{ref:h,className:"sr-only",dir:"rtl",children:[e.jsx("h2",{className:"text-center font-bold",children:"Daher.Net"}),e.jsx("p",{children:O().format("DD/MM/YYYY HH:mm")}),e.jsxs("div",{className:"mt-2",children:[e.jsx("strong",{children:"التفاصيل:"}),e.jsx("p",{children:v||"بدون ملاحظات"})]}),e.jsxs("div",{className:"mt-4 font-bold",children:[p,": ",n," $"]})]})]})})};function He(){var U;const P=X(),[m,p]=l.useState(!1),[h,x]=l.useState(""),[g,b]=l.useState(!1),[j,f]=l.useState(null),{data:d,isLoading:y}=E({queryKey:["customers-table"],queryFn:ie}),{data:n,isLoading:v}=E({queryKey:["balance-table"],queryFn:le}),{data:u,isLoading:r}=E({queryKey:["pending-exchange"],queryFn:oe}),{data:o}=E({queryKey:["monthly-revenue"],queryFn:fe}),s=l.useMemo(()=>{const t={cash:{total:0,count:0},shamCash:{total:0,count:0},other:{total:0,count:0}};return n!=null&&n.WifiPayments&&(n.WifiPayments.forEach(a=>{const c=Number(a.Amount)||0,i=a.type;i==="cash"||i==="shamCash"?(t[i].total+=c,t[i].count+=1):(t.other.total+=c,t.other.count+=1)}),n.WifiBalance.forEach(a=>{const c=Number(a.Amount)||0,i=a.type;i==="cash"||i==="shamCash"?(t[i].total+=c,t[i].count+=1):(t.other.total+=c,t.other.count+=1)})),t},[n]),D=l.useMemo(()=>d==null?void 0:d.reduce((t,a)=>(t[String(a.id)]=a,t),{}),[d]),H=l.useMemo(()=>{const t=(d==null?void 0:d.filter(a=>Number(a.Balance)<0).reduce((a,c)=>a+Number(c.Balance),0))??0;return Math.abs(t)},[d]),Y=l.useMemo(()=>{var c,i;if(!n)return 0;const t=((c=n.WifiBalance)==null?void 0:c.reduce((q,B)=>q+Number(B.amount),0))??0,a=((i=n.WifiPayments)==null?void 0:i.reduce((q,B)=>q+Number(B.Amount),0))??0;return t+a},[n]),w=new Date,{monthTotal:T,todayTotal:_}=l.useMemo(()=>{if(!(n!=null&&n.WifiPayments))return{monthTotal:0,todayTotal:0};let t=0,a=0;return n.WifiPayments.forEach(c=>{const i=new Date(c.Date);i.getFullYear()===w.getFullYear()&&i.getMonth()===w.getMonth()&&(t+=Number(c.Amount),i.getDate()===w.getDate()&&(a+=Number(c.Amount)))}),{monthTotal:t,todayTotal:a}},[n]),I=l.useMemo(()=>{var c;let t=0,a=0;return(c=u==null?void 0:u.pendingList)==null||c.forEach(i=>{t+=i.sypAmount||0,a+=i.usdAmount||0}),{syp:t,usd:a}},[u]),J=[{key:"amount",label:"الكمية",sortable:!0},{key:"details",label:"التفاصيل",sortable:!0},{key:"timestamp",label:"الوقت",sortable:!0}],G=[{key:"Amount",label:"الكمية",sortable:!0},{key:"customerName",label:"اسم الزبون",sortable:!0},{key:"type",label:"طريقة الدفع",sortable:!0},{key:"Details",label:"التفاصيل",sortable:!0},{key:"Date",label:"الوقت",sortable:!0}],$=[{key:"id",label:"ID",hidden:!0},{key:"sypAmount",label:"السوري",sortable:!0},{key:"usdAmount",label:"دولار",sortable:!0},{key:"details",label:"التفاصيل",sortable:!0},{key:"timestamp",label:"الوقت",sortable:!0}];return e.jsxs(Z,{children:[e.jsx(Ce,{isOpen:m,setIsOpen:p,formTitle:h}),e.jsxs("div",{dir:"rtl",className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx(N,{className:"rounded-b-none",title:"الرصيد الحالي",value:Y,icon:je,trend:{value:Y-T,isPositive:Y-T>0},loading:v}),e.jsxs("div",{className:"flex",children:[e.jsx(k,{className:"w-1/2 rounded-l-none rounded-t-none",onClick:()=>{x("إضافة دفعة إلى الصندوق"),p(!0)},children:"إضافة"}),e.jsx(k,{variant:"destructive",className:"w-1/2 rounded-r-none rounded-t-none",onClick:()=>{x("دفع من الصندوق"),p(!0)},children:"سحب"})]})]}),e.jsx(N,{title:"إيرادات هذا الشهر",value:T,icon:R,trend:{value:_,isPositive:!0}}),e.jsx(N,{title:"مقبوضات الشام كاش",value:s.shamCash.total,icon:R}),e.jsx(N,{title:"مقبوضات كاش",value:s.cash.total,icon:R}),e.jsx(N,{title:"الديون",value:H,icon:ee,loading:y,onClick:()=>P("/users",{state:"unpaid"})}),e.jsxs("div",{children:[e.jsx(N,{className:"rounded-b-none",title:"للتحويل",value:I.syp,icon:be,trend:{value:I.usd,isPositive:!1},loading:r}),e.jsx(ve,{className:"rounded-t-none",isOpen:g,setIsOpen:b})]})]}),e.jsx(te,{title:"الحركة المالية",type:"area",dataKey:"الفواتير",dataKey2:"المدفوعات",data:o?Object.entries(o).map(([t,a])=>({name:t,الفواتير:a.invoices,المدفوعات:a.payments})):[]}),e.jsxs("div",{dir:"rtl",className:"flex flex-col md:flex-row gap-4",children:[e.jsx(L,{title:"الصندوق",columns:J,data:[...(n==null?void 0:n.WifiBalance)??[]].reverse()}),e.jsx(L,{title:"الدفعات",columns:G,data:((U=n==null?void 0:n.WifiPayments)==null?void 0:U.map(t=>{var a;return{...t,customerName:((a=D==null?void 0:D[String(t.SubscriberID)])==null?void 0:a.Name)||"غير معروف"}}).reverse())??[]}),e.jsx(L,{title:"دفعات للتحويل",columns:$,data:(u==null?void 0:u.pendingList)??[],renderRowActions:t=>e.jsx(Se,{className:"",isOpen:j===t.id,setIsOpen:a=>f(a?t.id:null),SYPAmount:t.sypAmount,USDAmount:t.usdAmount,pendingId:t.id})})]})]})}export{He as default};
