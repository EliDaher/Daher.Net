import{V as D,r as a,k as F,l as I,v as l,j as t,D as x,s as w,w as Q,B as c,p as R,W as E}from"./index-5_oZtcep.js";import{c as _,r as B,s as K,g as M}from"./invoices-CyYimAQA.js";import{l as T}from"./index-BLRFddlS.js";function z(){const{data:u,isLoading:W}=D(),h=JSON.parse(localStorage.getItem("DaherUser"));a.useEffect(()=>{console.log(u)},[]);const[v,d]=a.useState(!1),[j]=a.useState("سبب الغاء العملية"),[y,g]=a.useState(""),[r,k]=a.useState(null),i=F(),[L,S]=a.useState(null);a.useEffect(()=>{const e=T("https://paynet-1.onrender.com");return S(e),e.on("pendingPaymentsUpdate",n=>{i.setQueryData(["pending-table"],n)}),()=>{e.disconnect()}},[i]);const{data:o,isLoading:P}=I({queryKey:["pending-table"],queryFn:M}),m=l({mutationFn:e=>_(e),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),C=l({mutationFn:e=>E(e),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),p=l({mutationFn:e=>B(e),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),f=l({mutationFn:e=>K(e),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),N=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"landline",label:"الرقم",sortable:!0},{key:"company",label:"الشركة",sortable:!0},{key:"speed",label:"السرعة",sortable:!0},{key:"email",label:"الحساب المرسل",sortable:!0},{key:"amount",label:"المبلغ الواجب دفعه",sortable:!0},{key:"status",label:"حالة العملية",sortable:!0},{key:"createdAt",label:"الوقت",sortable:!0}];a.useEffect(()=>{"Notification"in window&&Notification.requestPermission().then(e=>{console.log("Notification permission:",e)})},[]);const b=a.useRef([]);return a.useEffect(()=>{if(o&&o.length>0){const e=b.current,n=o.filter(s=>!e.some(q=>q._id===s._id));n.length>0&&(new Notification("طلب دفع جديد",{body:`المبلغ: ${n[0].amount} - الشركة: ${n[0].company}`,icon:"/logo.png"}),new Audio("/notification.mp3").play()),b.current=o}},[o]),P?t.jsx(x,{children:t.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):t.jsxs(x,{children:[t.jsx(w,{isOpen:v,setIsOpen:d,title:j,trigger:t.jsx(t.Fragment,{}),children:t.jsx("div",{className:"flex flex-row-reverse gap-2",children:t.jsxs("form",{onSubmit:e=>{e.preventDefault(),r&&(p.mutate({payment:{id:r._id,email:r.email,amount:r.amount},reason:y}),d(!1),g(""))},className:"space-y-4 w-full",children:[t.jsx(Q,{dir:"rtl",value:y,onChange:e=>g(e.target.value),type:"text",placeholder:"سبب الرفض (مثال: لا يوجد رصيد)",required:!0}),t.jsx(c,{type:"submit",children:"تأكيد الرفض"})]})})}),t.jsx("div",{dir:"rtl",className:"space-y-6",children:t.jsx(R,{amountBold:!0,title:"تسديدات معلقة",description:"",totalPend:!0,columns:N,data:o||[],renderRowActions:e=>e.status!="جاري التسديد"?t.jsxs("div",{className:"flex gap-2",children:[t.jsx(c,{variant:"default",size:"sm",onClick:()=>{var n;window.confirm("هل انت متأكد من انهاء العملية")&&(m.mutate(e._id),C.mutate({amount:e.amount,reason:"",company:e.company,number:e.number,companyId:u?(n=u.find(s=>s.name===e.company))==null?void 0:n.id:"",port:h.username}))},disabled:m.isPending,children:m.isPending?"...":"تأكيد"}),t.jsx(c,{variant:"destructive",size:"sm",onClick:()=>{k(e),d(!0)},disabled:p.isPending,children:p.isPending?"...":"رفض"})]}):t.jsx(t.Fragment,{children:t.jsx("div",{children:t.jsx(c,{variant:"default",disabled:f.isPending,onClick:()=>{const n=e.landline;let s=n;n.startsWith("033")?s=n.slice(3):n.startsWith("33")&&(s=n.slice(2)),n.startsWith("013")?s=n.slice(3):n.startsWith("13")&&(s=n.slice(2)),navigator.clipboard.writeText(s),f.mutate(e._id)},children:f.isPending?"...":"بدء التنفيذ"})})})})})]})}export{z as default};
