import{h as M,j as e,n as w,q as K,r as a,i as _,m as U}from"./index-CJDeOR-D.js";import{P as E}from"./PopupForm-wiHTllH-.js";import{B as c}from"./button-By_xk0nu.js";import{u as A,C as B}from"./index.esm-C3P_QZoB.js";import{u as m}from"./useMutation-WFqE7oBj.js";import{s as L}from"./pos-DI-3fcFl.js";import{F as D}from"./FormInput-G25TxeVJ.js";import{D as W}from"./DataTable-BowkCNWE.js";import{D as I}from"./DashboardLayout-y2KXrlW2.js";import{I as z}from"./input-GrzhRsEd.js";import{c as J,r as $,s as V,g as H}from"./invoices-DscnKQao.js";import{l as X}from"./index-BLRFddlS.js";import"./card-CHhuJT8d.js";import"./house-CfMLYBxw.js";function Y({isOpen:p,setIsOpen:v}){var x,h;const S=JSON.parse(localStorage.getItem("DaherUser")),f=M(),N=["512 Mbps - 14000","1 Mbps - 18500","2 Mbps - 24000","4 Mbps - 38000","8 Mbps - 64000","16 Mbps - 83000","البرونزية - 17500","العائلية - 22000","الذهبية - 29000","5 GB - 1800","10 GB - 3300","20 GB - 5700","30 GB - 7600","50 GB - 11500","75 GB - 13500","100 GB - 19000","200 GB - 35000"],u=["ناس","برونت","اينت","رنت","الكم","ليما","سوا","اية","يارا","بطاقات","هايبر","ويف","امنية","فيو","ليزر","متس","سما","زاد","دنيا","هاي فاي","تكامل","لاين","الجمعية"],{register:b,handleSubmit:g,reset:y,control:d,formState:{errors:l}}=A({defaultValues:{landline:"",selectedCompany:"",selectedSpeed:"",amountToPay:0,paymentType:"cash",email:S.username+"Ddaheradmin"}}),i=m({mutationFn:o=>L({formData:o}),onSuccess:()=>{f.invalidateQueries({queryKey:["pending-table"]}),y(),v(!1)},onError:()=>{alert("حدث خطأ أثناء إرسال الطلب")}}),q=o=>{i.mutate(o)};return e.jsx(E,{isOpen:p,setIsOpen:v,title:"إرسال رقم للتسديد",trigger:e.jsx(c,{className:"absolute bottom-8 right-8 z-50",children:"إرسال رقم للتسديد"}),children:e.jsxs("form",{onSubmit:g(q),className:"space-y-4",children:[e.jsx(D,{id:"landline",label:"رقم الهاتف / الخط",...b("landline",{required:"الرقم مطلوب"}),error:(x=l.landline)==null?void 0:x.message}),e.jsx(B,{name:"selectedCompany",control:d,rules:{required:"يرجى اختيار الشركة"},render:({field:o})=>e.jsxs("div",{dir:"rtl",className:"flex flex-col",children:[e.jsx("label",{className:"mb-1 mr-3 font-medium",children:"الشركة"}),e.jsxs("select",{...o,className:"border border-gray-300 p-2 bg-background rounded",children:[e.jsx("option",{value:"",children:"اختر الشركة"}),u.map(n=>e.jsx("option",{value:n,children:n},n))]}),l.selectedCompany&&e.jsx("span",{className:"text-red-500 text-sm mt-1",children:l.selectedCompany.message})]})}),e.jsx(B,{name:"selectedSpeed",control:d,rules:{required:"يرجى اختيار السرعة"},render:({field:o})=>e.jsxs("div",{dir:"rtl",className:"flex flex-col",children:[e.jsx("label",{className:"mb-1 mr-3 font-medium",children:"السرعة"}),e.jsxs("select",{...o,className:"border border-gray-300 p-2 bg-background rounded",children:[e.jsx("option",{value:"",children:"اختر السرعة"}),N.map(n=>e.jsx("option",{value:n,children:n},n))]}),l.selectedSpeed&&e.jsx("span",{className:"text-red-500 text-sm mt-1",children:l.selectedSpeed.message})]})}),e.jsx(D,{id:"amountToPay",label:"المبلغ المطلوب",type:"number",...b("amountToPay",{valueAsNumber:!0,required:"المبلغ مطلوب",min:{value:1,message:"المبلغ غير صالح"}}),error:(h=l.amountToPay)==null?void 0:h.message}),e.jsx(c,{type:"submit",className:"w-full mt-4",disabled:i.isPending,children:i.isPending?"جاري الإرسال...":"إرسال للتسديد"})]})})}function pe(){const{data:p,isLoading:v}=w(),S=JSON.parse(localStorage.getItem("DaherUser")),f=K(),[N,u]=a.useState(!1),[b]=a.useState("سبب الغاء العملية"),[g,y]=a.useState(""),[d,l]=a.useState(null),i=M(),[q,x]=a.useState(null),[h,o]=a.useState(!1);a.useEffect(()=>{const t=X("https://paynet-1.onrender.com");return x(t),t.on("pendingPaymentsUpdate",s=>{i.setQueryData(["pending-table"],s)}),()=>{t.disconnect()}},[i]);const{data:n,isLoading:G,isError:F,error:j}=_({queryKey:["pending-table"],queryFn:H});a.useEffect(()=>{F&&(j==null?void 0:j.message)==="No token found"&&f("/login")},[F,j,f]);const P=m({mutationFn:t=>J(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),Q=m({mutationFn:t=>U(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),k=m({mutationFn:t=>$(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),C=m({mutationFn:t=>V(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),O=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"landline",label:"الرقم",sortable:!0},{key:"company",label:"الشركة",sortable:!0},{key:"speed",label:"السرعة",sortable:!0},{key:"email",label:"الحساب المرسل",sortable:!0},{key:"amount",label:"المبلغ الواجب دفعه",sortable:!0},{key:"status",label:"حالة العملية",sortable:!0},{key:"createdAt",label:"الوقت",sortable:!0}];a.useEffect(()=>{"Notification"in window&&Notification.requestPermission().then(t=>{console.log("Notification permission:",t)})},[]);const T=a.useRef([]);return a.useEffect(()=>{if(n&&n.length>0){const t=T.current,s=n.filter(r=>!t.some(R=>R._id===r._id));s.length>0&&(new Notification("طلب دفع جديد",{body:`المبلغ: ${s[0].amount} - الشركة: ${s[0].company}`,icon:"/logo.png"}),new Audio("/notification.mp3").play()),T.current=n}},[n]),G?e.jsx(I,{children:e.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):e.jsxs(I,{children:[e.jsx(Y,{isOpen:h,setIsOpen:o}),e.jsx(E,{isOpen:N,setIsOpen:u,title:b,trigger:e.jsx(e.Fragment,{}),children:e.jsx("div",{className:"flex flex-row-reverse gap-2",children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),d&&(k.mutate({payment:{id:d._id,email:d.email,amount:d.amount},reason:g}),u(!1),y(""))},className:"space-y-4 w-full",children:[e.jsx(z,{dir:"rtl",value:g,onChange:t=>y(t.target.value),type:"text",placeholder:"سبب الرفض (مثال: لا يوجد رصيد)",required:!0}),e.jsx(c,{type:"submit",children:"تأكيد الرفض"})]})})}),e.jsx("div",{dir:"rtl",className:"space-y-6",children:e.jsx(W,{amountBold:!0,title:"تسديدات معلقة",description:"",totalPend:!0,columns:O,data:n||[],renderRowActions:t=>t.status!="جاري التسديد"?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"default",size:"sm",onClick:()=>{var s;window.confirm("هل انت متأكد من انهاء العملية")&&(P.mutate(t._id),Q.mutate({amount:t.amount,reason:"",company:t.company,number:t.landline||t.number,companyId:p?(s=p.find(r=>r.name===t.company))==null?void 0:s.id:"",port:S.username}))},disabled:P.isPending,children:P.isPending?"...":"تأكيد"}),e.jsx(c,{variant:"destructive",size:"sm",onClick:()=>{l(t),u(!0)},disabled:k.isPending,children:k.isPending?"...":"رفض"})]}):e.jsx(e.Fragment,{children:e.jsx("div",{children:e.jsx(c,{variant:"default",disabled:C.isPending,onClick:()=>{const s=t.landline;let r=s;s.startsWith("033")?r=s.slice(3):s.startsWith("33")&&(r=s.slice(2)),s.startsWith("013")?r=s.slice(3):s.startsWith("13")&&(r=s.slice(2)),navigator.clipboard.writeText(r),C.mutate(t._id)},children:C.isPending?"...":"بدء التنفيذ"})})})})})]})}export{pe as default};
