import{k as I,a6 as R,v as m,j as e,s as E,F as B,a7 as D,B as c,a8 as K,a9 as _,i as U,r as n,l as A,D as M,w as L,p as W,aa as z}from"./index-D9muoeqs.js";import{c as J,r as $,s as V,g as H}from"./invoices-DE6xmXEu.js";import{l as X}from"./index-BLRFddlS.js";function Y({isOpen:p,setIsOpen:v}){var x,h;const S=JSON.parse(localStorage.getItem("DaherUser")),b=I(),N=["512 Mbps - 14000","1 Mbps - 18500","2 Mbps - 24000","4 Mbps - 38000","8 Mbps - 64000","16 Mbps - 83000","البرونزية - 17500","العائلية - 22000","الذهبية - 29000","5 GB - 1800","10 GB - 3300","20 GB - 5700","30 GB - 7600","50 GB - 11500","75 GB - 13500","100 GB - 19000","200 GB - 35000"],u=["ناس","برونت","اينت","رنت","الكم","ليما","سوا","اية","يارا","بطاقات","هايبر","ويف","امنية","فيو","ليزر","متس","سما","زاد","دنيا","هاي فاي","تكامل","لاين","الجمعية"],{register:f,handleSubmit:g,reset:y,control:d,formState:{errors:o}}=R({defaultValues:{landline:"",selectedCompany:"",selectedSpeed:"",amountToPay:0,paymentType:"cash",email:S.username+"Ddaheradmin"}}),i=m({mutationFn:l=>K({formData:l}),onSuccess:()=>{b.invalidateQueries({queryKey:["pending-table"]}),y(),v(!1)},onError:()=>{alert("حدث خطأ أثناء إرسال الطلب")}}),q=l=>{i.mutate(l)};return e.jsx(E,{isOpen:p,setIsOpen:v,title:"إرسال رقم للتسديد",trigger:e.jsx(c,{className:"absolute bottom-8 right-8 z-50",children:"إرسال رقم للتسديد"}),children:e.jsxs("form",{onSubmit:g(q),className:"space-y-4",children:[e.jsx(B,{id:"landline",label:"رقم الهاتف / الخط",...f("landline",{required:"الرقم مطلوب"}),error:(x=o.landline)==null?void 0:x.message}),e.jsx(D,{name:"selectedCompany",control:d,rules:{required:"يرجى اختيار الشركة"},render:({field:l})=>e.jsxs("div",{dir:"rtl",className:"flex flex-col",children:[e.jsx("label",{className:"mb-1 mr-3 font-medium",children:"الشركة"}),e.jsxs("select",{...l,className:"border border-gray-300 p-2 bg-background rounded",children:[e.jsx("option",{value:"",children:"اختر الشركة"}),u.map(a=>e.jsx("option",{value:a,children:a},a))]}),o.selectedCompany&&e.jsx("span",{className:"text-red-500 text-sm mt-1",children:o.selectedCompany.message})]})}),e.jsx(D,{name:"selectedSpeed",control:d,rules:{required:"يرجى اختيار السرعة"},render:({field:l})=>e.jsxs("div",{dir:"rtl",className:"flex flex-col",children:[e.jsx("label",{className:"mb-1 mr-3 font-medium",children:"السرعة"}),e.jsxs("select",{...l,className:"border border-gray-300 p-2 bg-background rounded",children:[e.jsx("option",{value:"",children:"اختر السرعة"}),N.map(a=>e.jsx("option",{value:a,children:a},a))]}),o.selectedSpeed&&e.jsx("span",{className:"text-red-500 text-sm mt-1",children:o.selectedSpeed.message})]})}),e.jsx(B,{id:"amountToPay",label:"المبلغ المطلوب",type:"number",...f("amountToPay",{valueAsNumber:!0,required:"المبلغ مطلوب",min:{value:1,message:"المبلغ غير صالح"}}),error:(h=o.amountToPay)==null?void 0:h.message}),e.jsx(c,{type:"submit",className:"w-full mt-4",disabled:i.isPending,children:i.isPending?"جاري الإرسال...":"إرسال للتسديد"})]})})}function se(){const{data:p,isLoading:v}=_(),S=JSON.parse(localStorage.getItem("DaherUser")),b=U(),[N,u]=n.useState(!1),[f]=n.useState("سبب الغاء العملية"),[g,y]=n.useState(""),[d,o]=n.useState(null),i=I(),[q,x]=n.useState(null),[h,l]=n.useState(!1);n.useEffect(()=>{const t=X("http://localhost:5000");return x(t),t.on("pendingPaymentsUpdate",s=>{i.setQueryData(["pending-table"],s)}),()=>{t.disconnect()}},[i]);const{data:a,isLoading:G,isError:F,error:j}=A({queryKey:["pending-table"],queryFn:H});n.useEffect(()=>{F&&(j==null?void 0:j.message)==="No token found"&&b("/login")},[F,j,b]);const P=m({mutationFn:t=>J(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),Q=m({mutationFn:t=>z(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),k=m({mutationFn:t=>$(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),C=m({mutationFn:t=>V(t),onSuccess:()=>{i.invalidateQueries({queryKey:["pending-table"]})}}),w=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"landline",label:"الرقم",sortable:!0},{key:"company",label:"الشركة",sortable:!0},{key:"speed",label:"السرعة",sortable:!0},{key:"email",label:"الحساب المرسل",sortable:!0},{key:"amount",label:"المبلغ الواجب دفعه",sortable:!0},{key:"status",label:"حالة العملية",sortable:!0},{key:"createdAt",label:"الوقت",sortable:!0}];n.useEffect(()=>{"Notification"in window&&Notification.requestPermission().then(t=>{console.log("Notification permission:",t)})},[]);const T=n.useRef([]);return n.useEffect(()=>{if(a&&a.length>0){const t=T.current,s=a.filter(r=>!t.some(O=>O._id===r._id));s.length>0&&(new Notification("طلب دفع جديد",{body:`المبلغ: ${s[0].amount} - الشركة: ${s[0].company}`,icon:"/logo.png"}),new Audio("/notification.mp3").play()),T.current=a}},[a]),G?e.jsx(M,{children:e.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):e.jsxs(M,{children:[e.jsx(Y,{isOpen:h,setIsOpen:l}),e.jsx(E,{isOpen:N,setIsOpen:u,title:f,trigger:e.jsx(e.Fragment,{}),children:e.jsx("div",{className:"flex flex-row-reverse gap-2",children:e.jsxs("form",{onSubmit:t=>{t.preventDefault(),d&&(k.mutate({payment:{id:d._id,email:d.email,amount:d.amount},reason:g}),u(!1),y(""))},className:"space-y-4 w-full",children:[e.jsx(L,{dir:"rtl",value:g,onChange:t=>y(t.target.value),type:"text",placeholder:"سبب الرفض (مثال: لا يوجد رصيد)",required:!0}),e.jsx(c,{type:"submit",children:"تأكيد الرفض"})]})})}),e.jsx("div",{dir:"rtl",className:"space-y-6",children:e.jsx(W,{amountBold:!0,title:"تسديدات معلقة",description:"",totalPend:!0,columns:w,data:a||[],renderRowActions:t=>t.status!="جاري التسديد"?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{variant:"default",size:"sm",onClick:()=>{var s;window.confirm("هل انت متأكد من انهاء العملية")&&(P.mutate(t._id),Q.mutate({amount:t.amount,reason:"",company:t.company,number:t.landline||t.number,companyId:p?(s=p.find(r=>r.name===t.company))==null?void 0:s.id:"",port:S.username}))},disabled:P.isPending,children:P.isPending?"...":"تأكيد"}),e.jsx(c,{variant:"destructive",size:"sm",onClick:()=>{o(t),u(!0)},disabled:k.isPending,children:k.isPending?"...":"رفض"})]}):e.jsx(e.Fragment,{children:e.jsx("div",{children:e.jsx(c,{variant:"default",disabled:C.isPending,onClick:()=>{const s=t.landline;let r=s;s.startsWith("033")?r=s.slice(3):s.startsWith("33")&&(r=s.slice(2)),s.startsWith("013")?r=s.slice(3):s.startsWith("13")&&(r=s.slice(2)),navigator.clipboard.writeText(r),C.mutate(t._id)},children:C.isPending?"...":"بدء التنفيذ"})})})})})]})}export{se as default};
