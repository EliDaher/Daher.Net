import{r as s,k as w,l as N,v as p,j as t,D as b,w as q,x as C,B as r,p as D}from"./index-CPNwSYe_.js";import{c as F,r as R,s as I,g as Q}from"./invoices-BlVadPmb.js";import{l as _}from"./index-BLRFddlS.js";function W(){const[x,c]=s.useState(!1),[h]=s.useState("سبب الغاء العملية"),[f,y]=s.useState(""),[l,v]=s.useState(null),o=w(),[E,j]=s.useState(null);s.useEffect(()=>{const e=_("https://paynet-1.onrender.com");return j(e),e.on("pendingPaymentsUpdate",n=>{o.setQueryData(["pending-table"],n)}),()=>{e.disconnect()}},[o]);const{data:a,isLoading:k}=N({queryKey:["pending-table"],queryFn:Q}),u=p({mutationFn:e=>F(e),onSuccess:()=>{o.invalidateQueries({queryKey:["pending-table"]})}}),d=p({mutationFn:e=>R(e),onSuccess:()=>{o.invalidateQueries({queryKey:["pending-table"]})}}),m=p({mutationFn:e=>I(e),onSuccess:()=>{o.invalidateQueries({queryKey:["pending-table"]})}}),P=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"landline",label:"الرقم",sortable:!0},{key:"company",label:"الشركة",sortable:!0},{key:"speed",label:"السرعة",sortable:!0},{key:"email",label:"الحساب المرسل",sortable:!0},{key:"amount",label:"المبلغ الواجب دفعه",sortable:!0},{key:"status",label:"حالة العملية",sortable:!0},{key:"createdAt",label:"الوقت",sortable:!0}];s.useEffect(()=>{"Notification"in window&&Notification.requestPermission().then(e=>{console.log("Notification permission:",e)})},[]);const g=s.useRef([]);return s.useEffect(()=>{if(a&&a.length>0){const e=g.current,n=a.filter(i=>!e.some(S=>S._id===i._id));n.length>0&&(new Notification("طلب دفع جديد",{body:`المبلغ: ${n[0].amount} - الشركة: ${n[0].company}`,icon:"/logo.png"}),new Audio("/notification.mp3").play()),g.current=a}},[a]),k?t.jsx(b,{children:t.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):t.jsxs(b,{children:[t.jsx(q,{isOpen:x,setIsOpen:c,title:h,trigger:t.jsx(t.Fragment,{}),children:t.jsx("div",{className:"flex flex-row-reverse gap-2",children:t.jsxs("form",{onSubmit:e=>{e.preventDefault(),l&&(d.mutate({payment:{id:l._id,email:l.email,amount:l.amount},reason:f}),c(!1),y(""))},className:"space-y-4 w-full",children:[t.jsx(C,{dir:"rtl",value:f,onChange:e=>y(e.target.value),type:"text",placeholder:"سبب الرفض (مثال: لا يوجد رصيد)",required:!0}),t.jsx(r,{type:"submit",children:"تأكيد الرفض"})]})})}),t.jsx("div",{dir:"rtl",className:"space-y-6",children:t.jsx(D,{amountBold:!0,title:"تسديدات معلقة",description:"",columns:P,data:a||[],renderRowActions:e=>e.status!="جاري التسديد"?t.jsxs("div",{className:"flex gap-2",children:[t.jsx(r,{variant:"default",size:"sm",onClick:()=>{window.confirm("هل انت متأكد من انهاء العملية")&&u.mutate(e._id)},disabled:u.isPending,children:u.isPending?"...":"تأكيد"}),t.jsx(r,{variant:"destructive",size:"sm",onClick:()=>{v(e),c(!0)},disabled:d.isPending,children:d.isPending?"...":"رفض"})]}):t.jsx(t.Fragment,{children:t.jsx("div",{children:t.jsx(r,{variant:"default",disabled:m.isPending,onClick:()=>{const n=e.landline;let i=n;n.startsWith("033")?i=n.slice(3):n.startsWith("33")&&(i=n.slice(2)),n.startsWith("013")?i=n.slice(3):n.startsWith("13")&&(i=n.slice(2)),navigator.clipboard.writeText(i),m.mutate(e._id)},children:m.isPending?"...":"بدء التنفيذ"})})})})})]})}export{W as default};
