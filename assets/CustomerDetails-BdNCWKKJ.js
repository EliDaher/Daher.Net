import{r as n,e as H,J as f,j as e,s as J,m as O,o as _,f as E}from"./index-BgjzOHka.js";import{D as R}from"./DashboardLayout-P3XUXwj6.js";import{C as L,a as W,b as G,c as X}from"./card-BeiAbVYm.js";import{a as Z,B as h}from"./button-BrQsrS7q.js";import{S as ee,D as te}from"./DataTable-DgfOsqsb.js";import{b as ae,c as se,e as re}from"./wifi-C3D413KV.js";import{D as ne}from"./DetailsInputs-B1iNtNAx.js";import{l as $}from"./index-BZbB0na9.js";import{P as ie,m as M,A as le}from"./PopupForm-DcJrxY53.js";import{d as A,L as oe,A as de,D as ce}from"./DatePicker-C-vUY6Om.js";import{u as me,C as D}from"./index.esm-Dhtil0Dq.js";import{z as v,t as ue}from"./index-DUPkLR7_.js";import{F}from"./FormInput-jU1o1Mi-.js";import{S as K,a as Q,b as T,c as z,d as x}from"./select-B0EirBKZ.js";import{u as I}from"./useMutation-b-dUq8l8.js";import{a as xe}from"./exchange-Bmp4j1Li.js";import{A as he}from"./arrow-left-DfhTKbZS.js";import{P as V}from"./plus-Uw6NWjqK.js";import"./house-CzX8uGDh.js";import"./input-DBlcqyhk.js";import"./index-D9TmKjbE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=Z("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),pe=v.object({amount:v.coerce.number({invalid_type_error:"القيمة مطلوبة"}),date:v.any().nullable(),type:v.enum(["cash","shamCash"]),details:v.string().optional()}),ye=({isOpen:l,setIsOpen:p,formTitle:q,printOnly:i=!1,customer:a})=>{const c=n.useRef(null),r=H(),[y,j]=n.useState("USD"),[b,g]=n.useState(0),{control:o,handleSubmit:C,watch:s,formState:{errors:S,isSubmitting:m},reset:Y}=me({resolver:ue(pe),defaultValues:{amount:0,date:A(),details:"",type:"cash"}}),k=s("amount"),N=s("details"),P=s("type"),w=$.useReactToPrint({contentRef:c,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body { font-family: Arial; font-size: 12px; direction: rtl; }
    `}),d=()=>A().format("DD/MM/YYYY HH:mm"),u=I({mutationFn:ae,onSuccess:()=>{r.invalidateQueries({queryKey:["balance-table"]}),r.invalidateQueries({queryKey:["customer",a.id]}),r.invalidateQueries({queryKey:["transactions",a.id]}),window.confirm("هل تريد طباعة إيصال؟")&&w(),Y(),p(!1)},onError:()=>{f.error("❌ حدث خطأ أثناء تسجيل الدفعة")}}),B=I({mutationFn:t=>xe(t),onSuccess:()=>{r.invalidateQueries({queryKey:["pendingEx"]}),r.invalidateQueries({queryKey:["balance-table"]}),r.invalidateQueries({queryKey:["customer",a.id]}),r.invalidateQueries({queryKey:["transactions",a.id]}),f.success("تم الاضافة بمجاح"),w(),p(!1)},onError:()=>{f.error("حدث خطأ اثناء الاضافة")}}),U=t=>{if(!(a!=null&&a.id)){f.error("❌ المشترك غير معروف");return}window.confirm(`تأكيد تسجيل دفعة بقيمة ${t.amount}$ ؟`)&&(u.mutate({amount:t.amount,date:A(t.date).format("YYYY-MM-DD"),details:t.details,subscriberID:a.id,total:a.Balance??0,type:t.type}),y=="SYP"&&B.mutate({sypAmount:b,usdAmount:t.amount,details:t.details}))};return e.jsx(ie,{trigger:e.jsx(e.Fragment,{}),isOpen:l,setIsOpen:p,title:q,children:e.jsxs("div",{className:"flex flex-row-reverse gap-4",children:[!i&&e.jsxs(M.form,{layout:!0,onSubmit:C(U),className:"space-y-4 w-full",transition:{layout:{duration:.45,ease:[.22,1,.36,1]}},children:[e.jsx(D,{name:"amount",control:o,render:({field:t})=>e.jsx(F,{label:"القيمة بالدولار",...t,type:"number",placeholder:"Ex: 8"})}),S.amount&&e.jsx("p",{className:"text-red-500 text-sm",children:S.amount.message}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(D,{name:"type",control:o,render:({field:t})=>e.jsxs(K,{value:t.value,onValueChange:t.onChange,children:[e.jsx(Q,{children:e.jsx(T,{placeholder:"نوع الدفع"})}),e.jsxs(z,{children:[e.jsx(x,{value:"none",disabled:!0,children:"اختر نوع الدفع"}),e.jsx(x,{value:"cash",children:"Cash"}),e.jsx(x,{value:"shamCash",children:"Sham Cash"})]})]})}),e.jsxs(K,{value:y,onValueChange:t=>j(t),children:[e.jsx(Q,{children:e.jsx(T,{placeholder:"العملة"})}),e.jsxs(z,{children:[e.jsx(x,{value:"none",disabled:!0,children:"اختر نوع العملة المدفوع بها"}),e.jsx(x,{value:"USD",children:"USD"}),e.jsx(x,{value:"SYP",children:"SYP"})]})]})]}),e.jsx(le,{children:y==="SYP"&&e.jsx(M.div,{layout:!0,initial:{opacity:0,scale:.96,y:-8,filter:"blur(6px)"},animate:{opacity:1,scale:1,y:0,filter:"blur(0px)"},exit:{opacity:0,scale:.96,y:-8,filter:"blur(6px)"},transition:{type:"spring",stiffness:260,damping:22},className:"overflow-hidden rounded-xl border border-border/40 bg-background/60 backdrop-blur-md p-3 shadow-sm",children:e.jsx(F,{label:"القيمة بالليرة السورية",type:"number",placeholder:"Ex: 100000",value:b,onChange:t=>g(Number(t.target.value))})},"syp-field")}),e.jsx(oe,{dateAdapter:de,children:e.jsx(D,{name:"date",control:o,render:({field:t})=>e.jsx(ce,{className:"text-foreground",...t,format:"DD/MM/YYYY"})})}),e.jsx(D,{name:"details",control:o,render:({field:t})=>e.jsx(F,{label:"التفاصيل",...t,type:"text",placeholder:""})}),e.jsx(h,{loading:u.isPending,type:"submit",disabled:m||u.isPending,className:"w-full",children:u.isPending?"جاري الحفظ...":"تأكيد الدفع"})]}),e.jsxs("div",{ref:c,className:"sr-only p-4 text-sm",dir:"rtl",children:[e.jsxs("div",{className:"text-center font-bold",children:[e.jsx("h1",{children:"Daher.Net"}),e.jsx("span",{children:d()})]}),e.jsxs("div",{className:"mt-2 font-bold",children:[e.jsxs("div",{children:["الاسم: ",a==null?void 0:a.Name]}),e.jsxs("div",{children:["الرقم: ",a==null?void 0:a.Contact]})]}),e.jsxs("div",{className:"mt-2",children:["نوع الدفع: ",P]}),e.jsxs("div",{className:"mt-2",children:["التفاصيل: ",N||"—"]}),e.jsxs("div",{className:"mt-4 border-t pt-2 font-extrabold",children:["المبلغ: ",k," $"]})]})]})})};function ze(){const{id:l}=J(),p=O(),i=_().state,a=JSON.parse(localStorage.getItem("DaherUser")||"{}"),[c,r]=n.useState(!1),[y,j]=n.useState(""),[b,g]=n.useState(!1),[o,C]=n.useState(null),{data:s,isLoading:S}=E({queryKey:["customer",l],queryFn:()=>se(l),enabled:!!l}),{data:m,isLoading:Y}=E({queryKey:["transactions",l],queryFn:()=>re(l),enabled:!!l});n.useEffect(()=>{s&&C({...s,address:(i==null?void 0:i.address)||""})},[s,i]);const k=()=>{if(!(s!=null&&s.Contact)){f.error("لا يوجد رقم هاتف للمشترك");return}if(s.Balance>=0){f.error("لا يوجد عليه فواتير");return}const d=s.Contact.replace(/\D/g,""),u=`عزيزي المشترك ${s.Name}، قيمة فاتورتك الحالية هي: ${s.Balance*-1} دولار.
يرجى التسديد قبل تاريخ 5-2-2026 لضمان استمرار الخدمة دون انقطاع.
شكرًا لثقتك بخدماتنا.`;window.open(`https://wa.me/${d}?text=${encodeURIComponent(u)}`,"_blank")},N=n.useRef(null),P=$.useReactToPrint({contentRef:N,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body {
        font-family: Arial;
        font-size: 12px;
        direction: rtl;
      }
      .no-print { display: none !important; }
    `,onAfterPrint:()=>r(!1)});if(n.useEffect(()=>{c&&b&&P()},[c,b,P]),S||!o)return e.jsx(R,{children:e.jsx(ee,{className:"h-64 w-full"})});const w=[{key:"amount",label:"الكمية",sortable:!0},{key:"Details",label:"التفاصيل",sortable:!0},{key:"date",label:"الوقت",sortable:!0}];return e.jsxs(R,{children:[e.jsx(ye,{isOpen:c,setIsOpen:r,formTitle:y,customer:{...s,address:(i==null?void 0:i.address)||""}}),e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات المشترك"}),e.jsxs(h,{onClick:()=>p("/users"),variant:"outline",children:[e.jsx(he,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(L,{children:[e.jsx(W,{children:e.jsx(G,{children:"المعلومات الأساسية"})}),e.jsx(X,{children:e.jsx(ne,{customer:o,setCustomer:C})})]}),e.jsxs("div",{className:"flex justify-start gap-2",children:[a.role==="admin"&&e.jsxs(h,{variant:"destructive",onClick:()=>{j("اضافة فاتورة"),g(!1),r(!0)},children:[e.jsx(V,{className:"w-4 h-4 ml-2"})," اصدار فاتورة"]}),e.jsxs(h,{onClick:()=>{j("اضافة دفعة"),g(!1),r(!0)},children:[e.jsx(V,{className:"w-4 h-4 ml-2"})," إضافة دفعة"]}),e.jsx(h,{variant:"outline",onClick:k,children:"واتساب"})]}),e.jsx(L,{className:"overflow-x-auto",ref:N,children:(m==null?void 0:m.length)===0?e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."}):e.jsx(te,{title:"البيان المالي",columns:w,data:m||[],defaultPageSize:5,getRowClassName:d=>d.type!=="payment"?"text-red-500":"text-green-500",renderRowActions:d=>e.jsx(h,{variant:"outline",onClick:()=>{j(d.type==="payment"?"اضافة دفعة":"اضافة فاتورة"),g(!0),r(!0)},children:e.jsx(fe,{})}),isLoading:Y})})]})]})}export{ze as default};
