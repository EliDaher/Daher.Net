import{r as n,g as w,j as t}from"./index-D0MVS834.js";import{D}from"./DataTable-x-1oLA7R.js";import{D as b}from"./DashboardLayout-BUONKmhf.js";import{B as r}from"./button-CCnNDblY.js";import{P as N}from"./PopupForm-z6So2YNv.js";import{I as q}from"./input-CzAk40Ef.js";import{c as C,r as F,s as I,g as R}from"./invoices-BHYzYkSJ.js";import{u as Q}from"./useQuery-DOoreUcc.js";import{u as m}from"./useMutation-DiZ-tFWe.js";import{l as _}from"./index-BLRFddlS.js";import"./card-BO-DkVXA.js";import"./house-sd8DDjuT.js";import"./axios-KE4dpIQc.js";import"./index-xsH4HHeE.js";function W(){const[x,l]=n.useState(!1),[h]=n.useState("سبب الغاء العملية"),[p,f]=n.useState(""),[o,v]=n.useState(null),s=w(),[E,j]=n.useState(null);n.useEffect(()=>{const e=_("https://paynet-cdji.onrender.com");return j(e),e.on("pendingPaymentsUpdate",a=>{s.setQueryData(["pending-table"],a)}),()=>{e.disconnect()}},[s]);const{data:i,isLoading:k}=Q({queryKey:["pending-table"],queryFn:R}),u=m({mutationFn:e=>C(e),onSuccess:()=>{s.invalidateQueries({queryKey:["pending-table"]})}}),c=m({mutationFn:e=>F(e),onSuccess:()=>{s.invalidateQueries({queryKey:["pending-table"]})}}),d=m({mutationFn:e=>I(e),onSuccess:()=>{s.invalidateQueries({queryKey:["pending-table"]})}}),P=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"landline",label:"الرقم",sortable:!0},{key:"company",label:"الشركة",sortable:!0},{key:"speed",label:"السرعة",sortable:!0},{key:"email",label:"الحساب المرسل",sortable:!0},{key:"amount",label:"المبلغ الواجب دفعه",sortable:!0},{key:"status",label:"حالة العملية",sortable:!0},{key:"createdAt",label:"الوقت",sortable:!0}];n.useEffect(()=>{"Notification"in window&&Notification.requestPermission().then(e=>{console.log("Notification permission:",e)})},[]);const g=n.useRef([]);return n.useEffect(()=>{if(i&&i.length>0){const e=g.current,a=i.filter(y=>!e.some(S=>S._id===y._id));a.length>0&&(new Notification("طلب دفع جديد",{body:`المبلغ: ${a[0].amount} - الشركة: ${a[0].company}`,icon:"/logo.png"}),new Audio("/notification.mp3").play()),g.current=i}},[i]),k?t.jsx(b,{children:t.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):t.jsxs(b,{children:[t.jsx(N,{isOpen:x,setIsOpen:l,title:h,trigger:t.jsx(t.Fragment,{}),children:t.jsx("div",{className:"flex flex-row-reverse gap-2",children:t.jsxs("form",{onSubmit:e=>{e.preventDefault(),o&&(c.mutate({payment:{id:o._id,email:o.email,amount:o.amount},reason:p}),l(!1),f(""))},className:"space-y-4 w-full",children:[t.jsx(q,{dir:"rtl",value:p,onChange:e=>f(e.target.value),type:"text",placeholder:"سبب الرفض (مثال: لا يوجد رصيد)",required:!0}),t.jsx(r,{type:"submit",children:"تأكيد الرفض"})]})})}),t.jsx("div",{dir:"rtl",className:"space-y-6",children:t.jsx(D,{amountBold:!0,title:"تسديدات معلقة",description:"",columns:P,data:i||[],renderRowActions:e=>e.status!="جاري التسديد"?t.jsxs("div",{className:"flex gap-2",children:[t.jsx(r,{variant:"default",size:"sm",onClick:()=>{window.confirm("هل انت متأكد من انهاء العملية")&&u.mutate(e._id)},disabled:u.isPending,children:u.isPending?"...":"تأكيد"}),t.jsx(r,{variant:"destructive",size:"sm",onClick:()=>{v(e),l(!0)},disabled:c.isPending,children:c.isPending?"...":"رفض"})]}):t.jsx(t.Fragment,{children:t.jsx("div",{children:t.jsx(r,{variant:"default",disabled:d.isPending,onClick:()=>{d.mutate(e._id)},children:d.isPending?"...":"بدء التنفيذ"})})})})})]})}export{W as default};
