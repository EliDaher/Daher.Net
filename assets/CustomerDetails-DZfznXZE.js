import{p as E,r as i,h as I,j as e,x as q,q as z,t as $,i as F}from"./index-BrafDqf2.js";import{D as R}from"./DashboardLayout-DGtZ8l5T.js";import{C as Y,a as B,b as H,c as O}from"./card-DbOQ1Rpi.js";import{B as h}from"./button-Cp711Bd4.js";import{S as V,D as K}from"./DataTable-DwQam0et.js";import{b as Q,c as U,e as _}from"./wifi-B4H6ERnj.js";import{D as J}from"./DetailsInputs-DeOY4aH3.js";import{l as M}from"./index-DnwYWRhP.js";import{P as W}from"./PopupForm-kHSY6XjT.js";import{d as P,L as G,A as X,D as Z}from"./DatePicker-B2ORo3he.js";import{u as ee,C as v}from"./index.esm-WEsnusO3.js";import{z as j,t as te}from"./index-BjLIRs2X.js";import{F as L}from"./FormInput-GAOeZM2x.js";import{S as se,a as ae,b as ne,c as re,d as D}from"./select-Bxwikg2F.js";import{u as ie}from"./useMutation-DMuYe1lt.js";import{A as oe}from"./arrow-left-YEdAQphJ.js";import{P as A}from"./plus-BopOokmG.js";import"./house-DlXleYzG.js";import"./input-Dy87e98L.js";import"./index-DsTpCJJj.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=E("Printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),de=j.object({amount:j.coerce.number({invalid_type_error:"القيمة مطلوبة"}),date:j.any().nullable(),type:j.enum(["cash","shamCash"]),details:j.string().optional()}),ce=({isOpen:r,setIsOpen:y,formTitle:k,printOnly:n=!1,customer:s})=>{const d=i.useRef(null),o=I(),{control:c,handleSubmit:p,watch:m,formState:{errors:u,isSubmitting:g},reset:b}=ee({resolver:te(de),defaultValues:{amount:0,date:P(),details:"",type:"cash"}}),a=m("amount"),N=m("details"),x=m("type"),S=M.useReactToPrint({contentRef:d,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body { font-family: Arial; font-size: 12px; direction: rtl; }
    `}),w=()=>P().format("DD/MM/YYYY HH:mm"),l=ie({mutationFn:Q,onSuccess:()=>{o.invalidateQueries({queryKey:["balance-table"]}),window.confirm("هل تريد طباعة إيصال؟")&&S(),b(),y(!1)},onError:()=>{alert("❌ حدث خطأ أثناء تسجيل الدفعة")}}),C=t=>{if(!(s!=null&&s.id)){alert("❌ المشترك غير معروف");return}window.confirm(`تأكيد تسجيل دفعة بقيمة ${t.amount}$ ؟`)&&l.mutate({amount:t.amount,date:P(t.date).format("YYYY-MM-DD"),details:t.details,subscriberID:s.id,total:s.Balance??0,type:t.type})};return e.jsx(W,{trigger:e.jsx(e.Fragment,{}),isOpen:r,setIsOpen:y,title:k,children:e.jsxs("div",{className:"flex flex-row-reverse gap-4",children:[!n&&e.jsxs("form",{onSubmit:p(C),className:"space-y-4 w-full",children:[e.jsx(v,{name:"amount",control:c,render:({field:t})=>e.jsx(L,{label:"القيمة بالدولار",...t,type:"number",placeholder:"Ex: 8"})}),u.amount&&e.jsx("p",{className:"text-red-500 text-sm",children:u.amount.message}),e.jsx(v,{name:"type",control:c,render:({field:t})=>e.jsxs(se,{value:t.value,onValueChange:t.onChange,children:[e.jsx(ae,{children:e.jsx(ne,{placeholder:"نوع الدفع"})}),e.jsxs(re,{children:[e.jsx(D,{value:"none",disabled:!0,children:"اختر نوع الدفع"}),e.jsx(D,{value:"cash",children:"Cash"}),e.jsx(D,{value:"shamCash",children:"Sham Cash"})]})]})}),e.jsx(G,{dateAdapter:X,children:e.jsx(v,{name:"date",control:c,render:({field:t})=>e.jsx(Z,{className:"text-foreground",...t,format:"DD/MM/YYYY"})})}),e.jsx(v,{name:"details",control:c,render:({field:t})=>e.jsx(L,{label:"التفاصيل",...t,type:"text",placeholder:""})}),e.jsx(h,{loading:l.isPending,type:"submit",disabled:g||l.isPending,className:"w-full",children:l.isPending?"جاري الحفظ...":"تأكيد الدفع"})]}),e.jsxs("div",{ref:d,className:"sr-only p-4 text-sm",dir:"rtl",children:[e.jsxs("div",{className:"text-center font-bold",children:[e.jsx("h1",{children:"Daher.Net"}),e.jsx("span",{children:w()})]}),e.jsxs("div",{className:"mt-2 font-bold",children:[e.jsxs("div",{children:["الاسم: ",s==null?void 0:s.Name]}),e.jsxs("div",{children:["الرقم: ",s==null?void 0:s.Contact]})]}),e.jsxs("div",{className:"mt-2",children:["نوع الدفع: ",x]}),e.jsxs("div",{className:"mt-2",children:["التفاصيل: ",N||"—"]}),e.jsxs("div",{className:"mt-4 border-t pt-2 font-extrabold",children:["المبلغ: ",a," $"]})]})]})})};function Ye(){const{id:r}=q(),y=z(),n=$().state,s=JSON.parse(localStorage.getItem("DaherUser")||"{}"),[d,o]=i.useState(!1),[c,p]=i.useState(""),[m,u]=i.useState(!1),[g,b]=i.useState(null),{data:a,isLoading:N}=F({queryKey:["customer",r],queryFn:()=>U(r),enabled:!!r}),{data:x,isLoading:S}=F({queryKey:["transactions",r],queryFn:()=>_(r),enabled:!!r});i.useEffect(()=>{a&&b({...a,address:(n==null?void 0:n.address)||""})},[a,n]);const w=()=>{if(!(a!=null&&a.Contact)){alert("لا يوجد رقم هاتف للمشترك");return}if(a.Balance>=0){alert("لا يوجد عليه فواتير");return}const f=a.Contact.replace(/\D/g,""),T=`عزيزي المشترك ${a.Name}، قيمة فاتورتك الحالية هي: ${a.Balance*-1} دولار.
يرجى التسديد قبل تاريخ 5-2-2026 لضمان استمرار الخدمة دون انقطاع.
شكرًا لثقتك بخدماتنا.`;window.open(`https://wa.me/${f}?text=${encodeURIComponent(T)}`,"_blank")},l=i.useRef(null),C=M.useReactToPrint({contentRef:l,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body {
        font-family: Arial;
        font-size: 12px;
        direction: rtl;
      }
      .no-print { display: none !important; }
    `,onAfterPrint:()=>o(!1)});if(i.useEffect(()=>{d&&m&&C()},[d,m,C]),N||!g)return e.jsx(R,{children:e.jsx(V,{className:"h-64 w-full"})});const t=[{key:"amount",label:"الكمية",sortable:!0},{key:"Details",label:"التفاصيل",sortable:!0},{key:"date",label:"الوقت",sortable:!0}];return e.jsxs(R,{children:[e.jsx(ce,{isOpen:d,setIsOpen:o,formTitle:c,customer:{...a,address:(n==null?void 0:n.address)||""}}),e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"بيانات المشترك"}),e.jsxs(h,{onClick:()=>y("/users"),variant:"outline",children:[e.jsx(oe,{className:"ml-2 w-4 h-4"})," رجوع"]})]}),e.jsxs(Y,{children:[e.jsx(B,{children:e.jsx(H,{children:"المعلومات الأساسية"})}),e.jsx(O,{children:e.jsx(J,{customer:g,setCustomer:b})})]}),e.jsxs("div",{className:"flex justify-start gap-2",children:[s.role==="admin"&&e.jsxs(h,{variant:"destructive",onClick:()=>{p("اضافة فاتورة"),u(!1),o(!0)},children:[e.jsx(A,{className:"w-4 h-4 ml-2"})," اصدار فاتورة"]}),e.jsxs(h,{onClick:()=>{p("اضافة دفعة"),u(!1),o(!0)},children:[e.jsx(A,{className:"w-4 h-4 ml-2"})," إضافة دفعة"]}),e.jsx(h,{variant:"outline",onClick:w,children:"واتساب"})]}),e.jsx(Y,{className:"overflow-x-auto",ref:l,children:(x==null?void 0:x.length)===0?e.jsx("p",{className:"text-muted-foreground text-center",children:"لا توجد معاملات حالياً."}):e.jsx(K,{title:"البيان المالي",columns:t,data:x||[],defaultPageSize:5,getRowClassName:f=>f.type!=="payment"?"text-red-500":"text-green-500",renderRowActions:f=>e.jsx(h,{variant:"outline",onClick:()=>{p(f.type==="payment"?"اضافة دفعة":"اضافة فاتورة"),u(!0),o(!0)},children:e.jsx(le,{})}),isLoading:S})})]})]})}export{Ye as default};
