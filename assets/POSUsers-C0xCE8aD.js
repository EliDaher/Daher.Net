import{r as l,u as te,j as e,c as ae,P as q,a as L,b as re,d as U,e as se,f as I,J as f}from"./index-BgjzOHka.js";import{D as R}from"./DataTable-DgfOsqsb.js";import{u as ne,P as le,C as oe,D as A}from"./DashboardLayout-P3XUXwj6.js";import{c as ie,B as k}from"./button-BrQsrS7q.js";import{P as F}from"./PopupForm-DcJrxY53.js";import{I as h}from"./input-DBlcqyhk.js";import{A as de,a as ce,b as ue,d as me,e as be,g as pe,c as xe,f as he}from"./pos-Wn2sosiZ.js";import{u as w}from"./useMutation-b-dUq8l8.js";import{u as fe}from"./index-D9TmKjbE.js";import{S as ye,a as ge,b as je,c as ve,d as M}from"./select-B0EirBKZ.js";import"./card-BeiAbVYm.js";import"./house-CzX8uGDh.js";var _="Checkbox",[ke,Qe]=ae(_),[Ce,Se]=ke(_),B=l.forwardRef((s,a)=>{const{__scopeCheckbox:r,name:o,checked:p,defaultChecked:m,required:y,disabled:n,value:i="on",onCheckedChange:c,...P}=s,[d,g]=l.useState(null),E=te(a,u=>g(u)),j=l.useRef(!1),D=d?!!d.closest("form"):!0,[x=!1,N]=ne({prop:p,defaultProp:m,onChange:c}),O=l.useRef(x);return l.useEffect(()=>{const u=d==null?void 0:d.form;if(u){const C=()=>N(O.current);return u.addEventListener("reset",C),()=>u.removeEventListener("reset",C)}},[d,N]),e.jsxs(Ce,{scope:r,state:x,disabled:n,children:[e.jsx(q.button,{type:"button",role:"checkbox","aria-checked":S(x)?"mixed":x,"aria-required":y,"data-state":H(x),"data-disabled":n?"":void 0,disabled:n,value:i,...P,ref:E,onKeyDown:L(s.onKeyDown,u=>{u.key==="Enter"&&u.preventDefault()}),onClick:L(s.onClick,u=>{N(C=>S(C)?!0:!C),D&&(j.current=u.isPropagationStopped(),j.current||u.stopPropagation())})}),D&&e.jsx(Pe,{control:d,bubbles:!j.current,name:o,value:i,checked:x,required:y,disabled:n,style:{transform:"translateX(-100%)"}})]})});B.displayName=_;var K="CheckboxIndicator",Q=l.forwardRef((s,a)=>{const{__scopeCheckbox:r,forceMount:o,...p}=s,m=Se(K,r);return e.jsx(le,{present:o||S(m.state)||m.state===!0,children:e.jsx(q.span,{"data-state":H(m.state),"data-disabled":m.disabled?"":void 0,...p,ref:a,style:{pointerEvents:"none",...s.style}})})});Q.displayName=K;var Pe=s=>{const{control:a,checked:r,bubbles:o=!0,...p}=s,m=l.useRef(null),y=fe(r),n=re(a);return l.useEffect(()=>{const i=m.current,c=window.HTMLInputElement.prototype,d=Object.getOwnPropertyDescriptor(c,"checked").set;if(y!==r&&d){const g=new Event("click",{bubbles:o});i.indeterminate=S(r),d.call(i,S(r)?!1:r),i.dispatchEvent(g)}},[y,r,o]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:S(r)?!1:r,...p,tabIndex:-1,ref:m,style:{...s.style,...n,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function S(s){return s==="indeterminate"}function H(s){return S(s)?"indeterminate":s?"checked":"unchecked"}var T=B,Ne=Q;const V=l.forwardRef(({className:s,...a},r)=>e.jsx(T,{ref:r,className:U("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...a,children:e.jsx(Ne,{className:U("flex items-center justify-center text-current"),children:e.jsx(oe,{className:"h-4 w-4"})})}));V.displayName=T.displayName;var Oe="Label",$=l.forwardRef((s,a)=>e.jsx(q.label,{...s,ref:a,onMouseDown:r=>{var p;r.target.closest("button, input, select, textarea")||((p=s.onMouseDown)==null||p.call(s,r),!r.defaultPrevented&&r.detail>1&&r.preventDefault())}}));$.displayName=Oe;var z=$;const we=ie("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),v=l.forwardRef(({className:s,...a},r)=>e.jsx(z,{ref:r,className:U(we(),s),...a}));v.displayName=z.displayName;function De({onSubmit:s}){const[a,r]=l.useState({email:"",password:"",name:"",number:"",card:{cardInternet:!0,cardSyriatel:!0,cardPlay:!0,cardapplication:!0,cardPronet:!1,cardHifi:!1},role:"user",balance:0}),o=n=>{const{name:i,value:c,type:P}=n.target;r({...a,[i]:P==="number"?Number(c):c})},p=(n,i)=>{r({...a,card:{...a.card,[n]:i}})},m=n=>{r({...a,role:n})},y=n=>{n.preventDefault(),s&&s(a),r({email:"",password:"",name:"",number:"",card:{cardInternet:!0,cardSyriatel:!0,cardPlay:!0,cardapplication:!0,cardPronet:!1,cardHifi:!1},role:"user",balance:0})};return e.jsx("div",{dir:"rtl",className:"max-w-md mx-auto bg-white rounded-lg shadow-md",children:e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"email",children:"البريد الإلكتروني"}),e.jsx(h,{id:"email",name:"email",type:"text",value:a.email,onChange:o,required:!0})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"password",children:"كلمة المرور"}),e.jsx(h,{id:"password",name:"password",type:"password",value:a.password,onChange:o})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"name",children:"الاسم"}),e.jsx(h,{id:"name",name:"name",type:"text",value:a.name,onChange:o})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"number",children:"الرقم"}),e.jsx(h,{id:"number",name:"number",type:"text",value:a.number,onChange:o})]}),e.jsxs("div",{children:[e.jsx(v,{children:"البطاقات"}),e.jsx("div",{className:"space-y-2",children:Object.entries(a.card).map(([n,i])=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(V,{id:n,checked:i,onCheckedChange:c=>p(n,c)}),e.jsx(v,{htmlFor:n,children:n.replace("card","")})]},n))})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"role",children:"الدور"}),e.jsxs(ye,{value:a.role,onValueChange:m,children:[e.jsx(ge,{children:e.jsx(je,{placeholder:"اختر الدور"})}),e.jsxs(ve,{children:[e.jsx(M,{value:"user",children:"مستخدم"}),e.jsx(M,{value:"admin",children:"مدير"})]})]})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"balance",children:"الرصيد"}),e.jsx(h,{id:"balance",name:"balance",type:"number",value:a.balance,onChange:o})]}),e.jsx(k,{type:"submit",className:"w-full",children:"إضافة المستخدم"})]})})}function He(){const[s,a]=l.useState(0),[r,o]=l.useState(null),[p,m]=l.useState(null),[y,n]=l.useState(!1),i=se(),[c,P]=l.useState({username:"",agent:"",owner:"",password:"",number:"",createdAt:new Date().toISOString().split("T")[0]}),d=t=>{P({...c,[t.target.name]:t.target.value})},{data:g,isLoading:E}=I({queryKey:["POSReport-table"],queryFn:pe});l.useEffect(()=>{console.log(g)},[g]);const{data:j,isLoading:D}=I({queryKey:["POSUsers-table"],queryFn:xe}),{data:x,isLoading:N}=I({queryKey:["POSdebt-table"],queryFn:he}),O=w({mutationFn:ce,onSuccess:()=>{f.success("تمت إضافة الدفعة."),i.invalidateQueries({queryKey:["POSdebt-table"]}),o(null),a(0)},onError:()=>{f.error("حدث خطأ أثناء الإرسال.")}}),u=w({mutationFn:be,onSuccess:()=>{f.success("تم انهاء الدين."),i.invalidateQueries({queryKey:["POSdebt-table"]}),o(null),a(0)},onError:()=>{f.error("حدث خطأ أثناء الإرسال.")}}),C=w({mutationFn:ue,onSuccess:()=>{f.success("تم اضافة نقطة البيع."),i.invalidateQueries({queryKey:["POSUsers-table"]}),o(null),a(0)},onError:()=>{f.error("حدث خطأ أثناء الإرسال.")}}),J=w({mutationFn:me,onSuccess:()=>{f.success("تم حذف المستخدم بنجاح."),i.invalidateQueries({queryKey:["POSUsers-table"]}),o(null),a(0)},onError:()=>{f.error("حدث خطأ أثناء الإرسال.")}}),X=w({mutationFn:de,onSuccess:()=>{f.success("تم إضافة المستخدم بنجاح."),i.invalidateQueries({queryKey:["POSUsers-table"]}),n(!1)},onError:()=>{f.error("حدث خطأ أثناء إضافة المستخدم.")}}),G=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"email",label:"البريد الإلكتروني",sortable:!0},{key:"confirmedDeposits",label:"الايداعات المؤكدة",sortable:!0},{key:"expensesPaid",label:"المصاريف المدفوعة",sortable:!0},{key:"netBalance",label:"الرصيد الصافي",sortable:!0},{key:"POSbalance",label:"الميزانية",sortable:!0},{key:"balance",label:"الرصيد",sortable:!0},{key:"expensesInProgress",label:"المصاريف الجارية",sortable:!0},{key:"totalDeposits",label:"إجمالي الإيداعات",sortable:!0},{key:"finalBalance",label:"الرصيد النهائي",sortable:!0},{key:"unconfirmedDeposits",label:"الايداعات المرفوضة",sortable:!0},{key:"expensesUnpaid",label:"المصاريف غير المدفوعة",sortable:!0},{key:"totalExpenses",label:"إجمالي المصاريف",sortable:!0}],W=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"name",label:"الاسم",sortable:!0},{key:"email",label:"email",sortable:!0},{key:"password",label:"كلمة السر",sortable:!0},{key:"role",label:"الصلاحية",sortable:!0},{key:"balance",label:"الرصيد",sortable:!0},{key:"number",label:"الرقم",sortable:!0}],Y=[{key:"_id",label:"المعرف",sortable:!0,hidden:!0},{key:"destination",label:"الوجهة",sortable:!0},{key:"name",label:"الاسم",sortable:!0},{key:"number",label:"الرقم",sortable:!0},{key:"operator",label:"المنفذ",sortable:!0},{key:"amount",label:"الكمية",sortable:!0},{key:"date",label:"التاريخ",sortable:!0}],Z=l.useMemo(()=>(x==null?void 0:x.reduce((t,b)=>t+Number(b.amount),0))??0,[x]),ee=l.useMemo(()=>(j==null?void 0:j.reduce((t,b)=>t+Number(b.balance),0))??0,[j]);return D||N?e.jsx(A,{children:e.jsx("div",{dir:"rtl",className:"space-y-6 text-center text-lg font-semibold",children:"جارِ تحميل البيانات..."})}):e.jsx(A,{children:e.jsxs("div",{dir:"rtl",className:"grid gap-4 grid-cols-1",children:[e.jsx(F,{title:"اضافة مستخدم جديد",trigger:e.jsx(k,{children:"اضافة مستخدم جديد"}),isOpen:y,setIsOpen:n,children:e.jsx(De,{onSubmit:t=>X.mutate(t)})}),e.jsx(R,{title:"نقاط البيع",description:ee.toFixed(0)+" ل.س مجموع أرصدة نقاط البيع",columns:W,data:j,renderRowActions:t=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{title:"اضافة دفعة لنقطة البيع",trigger:e.jsx(k,{variant:"accent",children:"اضافة دفعة"}),isOpen:r===t._id,setIsOpen:b=>o(b?t._id:null),children:e.jsx("div",{children:e.jsxs("form",{className:"gap-4 flex flex-col",onSubmit:b=>{b.preventDefault(),O.mutate({id:r,amount:s})},children:[e.jsx(h,{readOnly:!0,value:t.name?t.name+"  //  "+t.email:t.email,title:"نقطة البيع"}),e.jsx(h,{value:s,onChange:b=>{a(Number(b.target.value))},type:"number",title:"قيمة الدفعة"}),e.jsx(k,{children:O.isPending?"جاري التاكيد ...":"تأكيد"})]})})}),e.jsx(F,{title:"إضافة نقطة بيع",trigger:e.jsx(k,{children:"اضافة نقطة بيع فرعية"}),isOpen:p===t._id,setIsOpen:b=>m(b?t._id:null),children:e.jsx("div",{children:e.jsxs("form",{className:"gap-4 flex flex-col",onSubmit:b=>{b.preventDefault(),C.mutate({formData:c,email:t.email})},children:[e.jsx(h,{type:"text",name:"username",placeholder:"اسم المستخدم",value:c.username,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"password",placeholder:"كلمة المرور",value:c.password,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"number",placeholder:"رقم الخليوي",value:c.number,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"agent",placeholder:"الوكيل",value:t.email,readOnly:!0,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(h,{type:"text",name:"owner",placeholder:"اسم صاحب النقطة",value:c.owner,onChange:d,className:"w-full border px-3 py-2 rounded"}),e.jsx(k,{children:O.isPending?"جاري التاكيد ...":"تأكيد"})]})})}),e.jsx(k,{onClick:()=>{J.mutate({id:t._id})},variant:"destructive",children:"حذف نقطة البيع"})]})}),e.jsx(R,{title:"ديون نقاط البيع",description:Z,columns:Y,data:x,renderRowActions:t=>e.jsx(e.Fragment,{children:e.jsx(k,{disabled:u.isPending,onClick:()=>{window.confirm("هل انت متأكد من العملية ؟")&&u.mutate({id:t._id,email:t.email,amount:t.amount})},children:u.isPending?"جاري الانهاء...":"انهاء الدين"})})}),e.jsx(R,{title:"تقرير عمليات النقاط",data:(g==null?void 0:g.map(t=>({...t,POSbalance:t.confirmedDeposits-t.expensesPaid-t.netBalance})))||[],columns:G,isLoading:E,getRowClassName:t=>t.POSbalance!=0?"bg-destructive/20":"bg-green-500/20"})]})})}export{He as default};
