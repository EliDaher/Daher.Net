import{p as X,v as q,r as i,h as U,j as e,q as re,i as F}from"./index-BrafDqf2.js";import{D as oe,H as ie}from"./DashboardLayout-DGtZ8l5T.js";import{S as Y}from"./StatsCard-4H-A4FvG.js";import{C as le}from"./ChartContainer-CyaPbZkc.js";import{D as K}from"./DataTable-DwQam0et.js";import{f as ue,g as de,h as ce}from"./wifi-B4H6ERnj.js";import{m as me}from"./reports-mV1kzElv.js";import{B as w}from"./button-Cp711Bd4.js";import{P as O}from"./PopupForm-kHSY6XjT.js";import{F as P}from"./FormInput-GAOeZM2x.js";import{u as L}from"./useMutation-DMuYe1lt.js";import{l as Z}from"./index-DnwYWRhP.js";import{L as pe,A as ge,D as ye,d as J}from"./DatePicker-B2ORo3he.js";import{u as fe,C as z}from"./index.esm-WEsnusO3.js";import{z as M,t as xe}from"./index-BjLIRs2X.js";import{C as be}from"./credit-card-ldB0ZfRW.js";import"./house-DlXleYzG.js";import"./card-DbOQ1Rpi.js";import"./input-Dy87e98L.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=X("Coins",[["circle",{cx:"8",cy:"8",r:"6",key:"3yglwk"}],["path",{d:"M18.09 10.37A6 6 0 1 1 10.34 18",key:"t5s6rm"}],["path",{d:"M7 6h1v4",key:"1obek4"}],["path",{d:"m16.71 13.88.7.71-2.82 2.82",key:"1rbuyh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=X("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);async function ve(l){try{return(await q.post("/api/exchange/addPending",l)).data}catch(n){return console.error("Error adding payment:",n),{success:!1,error:n}}}async function Se(l){try{return(await q.delete("/api/exchange/deletePending",{data:l})).data}catch(n){return console.error("Error adding payment:",n),{success:!1,error:n}}}async function De(){try{return(await q.get("/api/exchange/getPending")).data}catch(l){return console.error("Error adding payment:",l),{success:!1,error:l}}}async function Pe(l){try{return(await q.post("/api/exchange/addDone",l)).data}catch(n){return console.error("Error adding payment:",n),{success:!1,error:n}}}function Ne({isOpen:l,setIsOpen:n,className:b}){const[g,j]=i.useState(0),[d,v]=i.useState(0),[S,h]=i.useState(""),N=U(),y=L({mutationFn:r=>ve(r),onSuccess:()=>{N.invalidateQueries({queryKey:["pendingEx"]}),alert("تم الاضافة بمجاح"),f(),n(!1)},onError:()=>{alert("حدث خطأ اثناء الاضافة")}}),D=i.useRef(),f=Z.useReactToPrint({contentRef:D,pageStyle:`
          @page {
            size: 80mm auto;
            margin: 0;
          }
    
          body {
            font-family: 'Arial', sans-serif;
            font-size: 12px;
            padding: 10px;
            color: black;
            direction: rtl;
          }
    
          .header {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
          }
    
          .totalValue {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
          }
    
          .cut {
            page-break-before: always;
            margin-top: 20px;
            text-align: center;
            font-style: italic;
          }
    
          div, span, p {
            break-inside: avoid;
          }
    
          .no-print {
            display: none !important;
          }
        `,onAfterPrint:()=>{console.log("تمت الطباعة بنجاح!"),n(!1)}}),c=()=>{const r=new Date,t={year:"numeric",month:"numeric",day:"numeric",weekday:"long",hour:"numeric",minute:"numeric",second:"numeric"};return r.toLocaleDateString("en-GB",t)};return e.jsx(O,{isOpen:l,setIsOpen:n,title:"تحويل",trigger:e.jsx(e.Fragment,{children:e.jsx(w,{className:b,variant:"accent",children:"تحويل"})}),children:e.jsxs("form",{onSubmit:r=>{r.preventDefault();let t={sypAmount:Number(g),usdAmount:Number(d),details:S};y.mutate(t)},className:"flex flex-col gap-4",children:[e.jsxs("div",{ref:D,children:[e.jsx("span",{children:c()}),e.jsx(P,{id:"SYPAmount",label:"العملة بالليرة السورية",value:g.toString(),type:"number",onChange:r=>{j(Number(r.target.value))}}),e.jsx(P,{id:"USDAmount",label:"العملة بالدولار",value:d.toString(),type:"number",onChange:r=>{v(Number(r.target.value))}}),e.jsx(P,{id:"exchangeDetails",label:"التفاصيل",value:S.toString(),type:"string",onChange:r=>{h(r.target.value)}})]}),e.jsx(w,{type:"submit",variant:"accent",disabled:y.isPending,children:y.isPending?"...":"تأكيد عملية التحويل"})]})})}function Ce({isOpen:l,setIsOpen:n,className:b,SYPAmount:g,USDAmount:j,pendingId:d}){const[v,S]=i.useState(0),[h,N]=i.useState(0),[y,D]=i.useState(""),f=U(),c=L({mutationFn:({id:t})=>Se({id:t}),onSuccess:(t,u)=>{f.invalidateQueries({queryKey:["pendingEx"]}),r.mutate(u.dataToDelete)},onError:()=>{alert("حدث خطأ أثناء الحذف")}}),r=L({mutationFn:t=>Pe(t),onSuccess:()=>{f.invalidateQueries({queryKey:["DoneEx"]}),alert("تم الانهاء بمجاح"),n(!1)},onError:()=>{alert("حدث خطأ اثناء الانهاء")}});return e.jsx(O,{isOpen:l,setIsOpen:n,title:"انهاء عملية التحويل",trigger:e.jsx(e.Fragment,{children:e.jsx(w,{className:b,variant:"accent",children:"انهاء عملية التحويل"})}),children:e.jsxs("form",{onSubmit:t=>{t.preventDefault();let u={finalSYP:v,finalUSD:h,sypAmount:Number(g),usdAmount:Number(j),details:y};c.mutate({id:d,dataToDelete:u})},className:"flex flex-col gap-4",children:[e.jsxs("span",{children:["المتوقع ",g," ليرة الى ",j," دولار"]}),e.jsx(P,{id:"finalSYP",label:"العملة بالليرة السورية",value:v.toString(),type:"number",onChange:t=>{S(Number(t.target.value))}}),e.jsx(P,{id:"finalUSD",label:"العملة بالدولار",value:h.toString(),type:"number",onChange:t=>{N(Number(t.target.value))}}),e.jsx(P,{id:"exchangeDetails",label:"التفاصيل",value:y.toString(),type:"string",onChange:t=>{D(t.target.value)}}),e.jsx(w,{type:"submit",variant:"accent",disabled:r.isPending||c.isPending,children:r.isPending||c.isPending?"...":"تأكيد عملية التحويل"})]})})}const ke=M.object({amount:M.number({invalid_type_error:"القيمة مطلوبة"}).positive("يجب أن تكون القيمة أكبر من 0"),date:M.any().nullable(),details:M.string().optional()}),we=({isOpen:l,setIsOpen:n,formTitle:b})=>{const g=i.useRef(null),j=U(),{control:d,handleSubmit:v,reset:S,watch:h,formState:{errors:N,isSubmitting:y}}=fe({resolver:xe(ke),defaultValues:{amount:0,date:null,details:""}}),D=h("amount"),f=h("details"),c=L({mutationFn:ue,onSuccess:()=>{alert("✅ تمت إضافة الدفعة."),j.invalidateQueries({queryKey:["balance-table"]}),S(),n(!1)},onError:()=>{alert("❌ حدث خطأ أثناء الإرسال.")}}),r=Z.useReactToPrint({contentRef:g,pageStyle:`
      @page { size: 80mm auto; margin: 0; }
      body { direction: rtl; font-size: 12px; }
      .no-print { display: none !important; }
    `}),t=u=>{window.confirm("هل تريد طباعة ايصال ؟")&&r(),c.mutate({amount:b==="اضافة دفعة الى الصندوق"?u.amount:-u.amount,date:u.date?J(u.date).format("YYYY-MM-DD"):"",details:u.details||""})};return e.jsx(O,{isOpen:l,setIsOpen:n,title:b,trigger:e.jsx(e.Fragment,{}),children:e.jsxs("div",{className:"p-2",children:[e.jsxs("form",{onSubmit:v(t),className:"space-y-4 w-full",children:[e.jsx(z,{name:"amount",control:d,render:({field:u})=>{var A;return e.jsx(P,{label:"",...u,type:"number",placeholder:"القيمة بالدولار",error:(A=N.amount)==null?void 0:A.message})}}),e.jsx(pe,{dateAdapter:ge,children:e.jsx(z,{name:"date",control:d,render:({field:u})=>e.jsx(ye,{className:"w-full",label:"اختر التاريخ",format:"DD/MM/YYYY",...u})})}),e.jsx(z,{name:"details",control:d,render:({field:u})=>e.jsx(P,{label:"",...u,type:"text",placeholder:"تفاصيل (اختياري)"})}),e.jsx("button",{type:"submit",disabled:y||c.isPending,className:"w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition",children:c.isPending?"جارٍ الحفظ...":"حفظ"})]}),e.jsxs("div",{ref:g,className:"sr-only",dir:"rtl",children:[e.jsx("h2",{className:"text-center font-bold",children:"Daher.Net"}),e.jsx("p",{children:J().format("DD/MM/YYYY HH:mm")}),e.jsxs("div",{className:"mt-2",children:[e.jsx("strong",{children:"التفاصيل:"}),e.jsx("p",{children:f||"بدون ملاحظات"})]}),e.jsxs("div",{className:"mt-4 font-bold",children:[b,": ",D," $"]})]})]})})};function Ge(){const l=re(),[n,b]=i.useState(0),[g,j]=i.useState(0),[d,v]=i.useState(0),[S,h]=i.useState(null),[N,y]=i.useState(!1),[D,f]=i.useState(!1),[c,r]=i.useState(""),{data:t,isLoading:u}=F({queryKey:["customers-table"],queryFn:de}),A=i.useMemo(()=>{var o;const a=(o=t==null?void 0:t.filter(m=>(m==null?void 0:m.Balance)<0))==null?void 0:o.reduce((m,C)=>m+Number(C==null?void 0:C.Balance),0);return Math.abs(a)},[t]),{data:s,isLoading:T}=F({queryKey:["balance-table"],queryFn:ce});i.useEffect(()=>{var V,_,G,$;let a=0;(V=s==null?void 0:s.WifiBalance)==null||V.map(p=>{a+=Number(p.amount)}),(_=s==null?void 0:s.WifiPayments)==null||_.map(p=>{a+=Number(p.Amount)}),b(a);const o=new Date,m=o.getFullYear(),C=o.getMonth(),se=o.getDate(),R=(G=s==null?void 0:s.WifiPayments)==null?void 0:G.filter(p=>{const k=new Date(p.Date);return k.getFullYear()===m&&k.getMonth()===C}),W=($=s==null?void 0:s.WifiPayments)==null?void 0:$.filter(p=>{const k=new Date(p.Date);return k.getFullYear()===m&&k.getMonth()===C&&k.getDate()===se});let I=0;R==null||R.map(p=>{I+=Number(p.Amount)}),v(I);let H=0;W==null||W.map(p=>{H+=Number(p.Amount)}),j(H)},[s]);const{data:x,isLoading:ee}=F({queryKey:["pendingEx"],queryFn:De}),E=i.useMemo(()=>{let a=0,o=0;return x==null||x.pendingList.forEach(m=>{a+=m.sypAmount||0,o+=m.usdAmount||0}),{sypTotal:a,usdTotal:o}},[x]),{data:Q,isLoading:Ae}=F({queryKey:["monthlyRevenue"],queryFn:me}),te=[{key:"id",label:"المعرف",sortable:!0,hidden:!0},{key:"sypAmount",label:"السوري",sortable:!0},{key:"usdAmount",label:"دولار",sortable:!0},{key:"details",label:"التفاصيل",sortable:!0},{key:"timestamp",label:"الوقت",sortable:!0}],ne=[{key:"amount",label:"الكمية",sortable:!0},{key:"details",label:"التفاصيل",sortable:!0},{key:"timestamp",label:"الوقت",sortable:!0}],ae=[{key:"Amount",label:"الكمية",sortable:!0},{key:"customerName",label:"اسم الزبون",sortable:!0},{key:"type",label:"طريقة الدفع",sortable:!0},{key:"Details",label:"التفاصيل",sortable:!0},{key:"Date",label:"الوقت",sortable:!0}],B=t==null?void 0:t.reduce((a,o)=>(a[String(o.id)]=o,a),{});return e.jsxs(oe,{children:[e.jsx(we,{isOpen:D,setIsOpen:f,formTitle:c}),e.jsxs("div",{dir:"rtl",className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{children:[e.jsx(Y,{className:"rounded-b-none",title:"الرصيد الحالي",value:n||0,description:" . فرق عن الشهر السابق",icon:je,trend:{value:n-d||0,isPositive:n-d>0},loading:T}),e.jsxs("div",{className:"",children:[e.jsx(w,{onClick:()=>{r("اضافة دفعة الى الصندوق"),f(!0)},className:"w-1/2 rounded-l-none rounded-tr-none",disabled:T,children:"اضف دفعة"}),e.jsx(w,{variant:"destructive",onClick:()=>{r("دفع من الصندوق"),f(!0)},className:"w-1/2 rounded-r-none rounded-tl-none",disabled:T,children:"دفع من الصندوق"})]})]}),e.jsx(Y,{title:"ايرادات هذا الشهر",value:d||0,description:" . اليوم",icon:be,trend:{value:g||0,isPositive:!0}}),e.jsx(Y,{onClick:()=>{l("/users",{state:"unpaid"})},title:"الديون",value:A||0,description:"",icon:ie,loading:u}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(Y,{className:"rounded-b-none",title:"للتحويل",value:E.sypTotal,description:" . دولار",icon:he,trend:{value:(E==null?void 0:E.usdTotal)||0,isPositive:!1},loading:ee}),e.jsx(Ne,{className:"rounded-t-none w-full",isOpen:N,setIsOpen:y})]})]}),e.jsx(le,{className:"mdL:col-span-2",title:" الحركة المالية ",data:Q?Object.entries(Q).map(([a,o])=>({name:a,الفواتير:o.invoices,المدفوعات:o.payments})):[],type:"area",dataKey2:"المدفوعات",dataKey:"الفواتير"}),e.jsxs("div",{dir:"rtl",className:"flex flex-col md:flex-row gap-4",children:[e.jsx(K,{title:"الصندوق",description:"",columns:ne,data:s!=null&&s.WifiBalance?[...s.WifiBalance].reverse():[]}),e.jsx(K,{title:"الدفعات",description:"دفعات المشتركين",columns:ae,data:s!=null&&s.WifiPayments?s.WifiPayments.map(a=>{var o;return{...a,customerName:((o=B==null?void 0:B[String(a.SubscriberID)])==null?void 0:o.Name)||"غير معروف"}}).reverse():[]}),e.jsx(K,{title:"دفعات للتحويل",description:"",columns:te,data:x!=null&&x.pendingList?x==null?void 0:x.pendingList:[],renderRowActions:a=>e.jsx(Ce,{isOpen:S===a.id,setIsOpen:o=>h(o?a.id:null),className:"",SYPAmount:a.sypAmount,USDAmount:a.usdAmount,pendingId:a.id})})]})]})}export{Ge as default};
